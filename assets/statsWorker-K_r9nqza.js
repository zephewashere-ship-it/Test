(function(){"use strict";const ln=["selfBuffs","groupBuffs","squadBuffs"],un=n=>n!=null&&n.classification?n.classification==="Boon":!0,dn=n=>`b${n}`,On=(n,t)=>{const i=Array.isArray(n==null?void 0:n.activeTimes)?n.activeTimes:[],l=typeof i[0]=="number"?i[0]:0;return l>0?l:t},fn=(n,t,i,l,b,h,B)=>{const k=n==="selfBuffs"?1:Math.max(n==="groupBuffs"?h-1:B-1,0);return!k||!b?{generationMs:0,wastedMs:0}:t?{generationMs:i*b*k,wastedMs:l*b*k}:{generationMs:i/100*b*k,wastedMs:l/100*b*k}},$n=n=>{const t=new Map,i=new Map;return n.forEach(h=>{const B=h.details;if(!B)return;const k=B.durationMS||0,N=B.buffMap||{};Object.entries(N).forEach(([g,C])=>{if(!t.has(g)){t.set(g,C);return}const I=t.get(g)||{},d={name:I.name||C.name,stacking:I.stacking??C.stacking,icon:I.icon||C.icon,classification:I.classification||C.classification};t.set(g,d)});const pe=(B.players||[]).filter(g=>!g.notInSquad),U=pe.length,y=new Map;pe.forEach(g=>{const C=g.group??0;y.set(C,(y.get(C)||0)+1)}),pe.forEach(g=>{const C=g.account||g.name||g.character_name||"Unknown",I=g.profession||"Unknown",d=g.group??0,M=y.get(d)||1,P=On(g,k);i.has(C)||i.set(C,{account:C,profession:I,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const A=i.get(C);A.profession=I,I!=="Unknown"&&(A.professions.add(I),A.professionTimeMs[I]=(A.professionTimeMs[I]||0)+P),A.activeTimeMs+=P,A.numFights+=1,A.groupSupported+=M,A.squadSupported+=U,ln.forEach(R=>{(g[R]||[]).forEach(q=>{var Z,ce,J,Be;if(typeof(q==null?void 0:q.id)!="number")return;const oe=dn(q.id),z=N[oe];if(!un(z))return;const _=(z==null?void 0:z.stacking)??!1,he=((ce=(Z=q.buffData)==null?void 0:Z[0])==null?void 0:ce.generation)??0,H=((Be=(J=q.buffData)==null?void 0:J[0])==null?void 0:Be.wasted)??0,{generationMs:O,wastedMs:fe}=fn(R,_,he,H,k,M,U);!O&&!fe||(t.has(oe)||t.set(oe,z||{}),A.boons[oe]||(A.boons[oe]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),A.boons[oe][R].generationMs+=O,A.boons[oe][R].wastedMs+=fe)})})})}),{boonTables:Array.from(t.keys()).filter(h=>un(t.get(h))).map(h=>{const B=t.get(h)||{},k=[];return i.forEach(N=>{var g;const ie=N.boons[h];if(!ie||!ln.some(C=>ie[C].generationMs>0||ie[C].wastedMs>0))return;const U=Array.from(N.professions||[]).filter(C=>C&&C!=="Unknown");let y=N.profession;if(U.length>0){y=U[0];let C=((g=N.professionTimeMs)==null?void 0:g[y])||0;U.forEach(I=>{var M;const d=((M=N.professionTimeMs)==null?void 0:M[I])||0;d>C&&(C=d,y=I)})}k.push({account:N.account,profession:y||"Unknown",professionList:U,activeTimeMs:N.activeTimeMs||1,numFights:N.numFights||1,groupSupported:N.groupSupported||1,squadSupported:N.squadSupported||1,categories:{selfBuffs:{...ie.selfBuffs},groupBuffs:{...ie.groupBuffs},squadBuffs:{...ie.squadBuffs}}})}),{id:h,name:B.name||h,icon:B.icon,stacking:B.stacking??!1,rows:k}}).filter(h=>h.rows.length>0)}},mn=(n,t,i,l,b,h,B={})=>{var g,C,I,d;const N=((n==null?void 0:n[t])||[]).find(M=>M.id===i);if(!N)return{generationMs:0,wastedMs:0};const ie=B[dn(i)],pe=(ie==null?void 0:ie.stacking)??!1,U=((C=(g=N.buffData)==null?void 0:g[0])==null?void 0:C.generation)??0,y=((d=(I=N.buffData)==null?void 0:I[0])==null?void 0:d.wasted)??0;return fn(t,pe,U,y,l,b,h)};var xn={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Wn=xn,Ze="count",_n=n=>(n||0)/1e3,Hn=(n,t)=>{var b;if(!n)return 0;const i=(b=Wn.methods.tiered)==null?void 0:b.tiers;if(!i)return n;const l=t/Math.max(n,1);return l<=i.shortMs?n*i.weights.short:l<=i.mediumMs?n*i.weights.medium:n*i.weights.long},pn=(n,t,i)=>i==="duration"?_n(t):i==="tiered"?Hn(n,t):n;function jn(n,t=Ze){var h;const i=(h=n.statsAll)==null?void 0:h[0],l=Number((i==null?void 0:i.appliedCrowdControl)??0),b=Number((i==null?void 0:i.appliedCrowdControlDuration)??0);return pn(l,b,t)}function Vn(n,t){const i=(t==null?void 0:t.durationMS)||0,l=(t==null?void 0:t.buffMap)||{},b=n.filter(k=>!k.notInSquad),h=b.length,B=new Map;b.forEach(k=>{const N=k.group??0;B.set(N,(B.get(N)||0)+1)}),b.forEach(k=>{const N=B.get(k.group??0)||1,ie=mn(k,"selfBuffs",1122,i,N,h,l),pe=mn(k,"squadBuffs",1122,i,N,h,l);k.stabGeneration=(ie.generationMs+pe.generationMs)/1e3})}function zn(n){if(!n.statsTargets)return 0;let t=0;for(const i of n.statsTargets)i&&i.length>0&&(t+=i[0].downContribution||0);return t}function Kn(n){if(!n.extBarrierStats||!n.extBarrierStats.outgoingBarrierAllies)return 0;let t=0;for(const i of n.extBarrierStats.outgoingBarrierAllies)if(i)for(const l of i)l&&(t+=l.barrier||0);return t}function Gn(n){if(!n.extHealingStats||!n.extHealingStats.outgoingHealingAllies)return 0;let t=0;for(const i of n.extHealingStats.outgoingHealingAllies)if(i)for(const l of i)l&&(t+=l.healing||0);return t}const Jn=n=>{var t,i,l,b;return(((i=(t=n.support)==null?void 0:t[0])==null?void 0:i.condiCleanse)||0)+(((b=(l=n.support)==null?void 0:l[0])==null?void 0:b.condiCleanseSelf)||0)},Yn=(n,t=Ze)=>{var h;const i=(h=n.support)==null?void 0:h[0],l=Number((i==null?void 0:i.boonStrips)??0),b=Number((i==null?void 0:i.boonStripsTime)??0);return pn(l,b,t)},Qn=n=>zn(n),Xn=n=>Gn(n),Zn=n=>Kn(n),et=(n,t=Ze)=>jn(n,t),nt=(n,t)=>Vn(n,t),tt="count",ot={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},st={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},gn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),it={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},Ge=n=>{if(!n)return null;const t=n.trim().toLowerCase(),i=gn.get(t);if(i)return i;const l=t.split(/[^a-z]+/).filter(Boolean);for(const b of l){const h=gn.get(b);if(h)return h}return null},bn=n=>{const t=new Map;return n&&(Object.values(n).forEach(i=>{if(!(i!=null&&i.icon)||!(i!=null&&i.name))return;const l=Ge(i.name);l&&(t.has(l)||t.set(l,i.icon))}),Object.entries(it).forEach(([i,l])=>{t.has(i)||t.set(i,l)})),t},Je=(n,t,i)=>{var l;if(t&&i){const b=(l=i[`b${t}`])==null?void 0:l.name,h=Ge(b);if(h)return h}return n?Ge(n):null},at=n=>{const t=(n==null?void 0:n.account)||"Unknown";return t&&t!=="Unknown"?t:(n==null?void 0:n.name)||"Unknown"||null},rt=n=>{if(!n||n.length===0)return 0;let t=0,i=null;return n.forEach(l=>{const b=Number(l[1]??0);if(Number.isFinite(b)){if(i===null){i=b;return}b>i&&(t+=b-i),i=b}}),t},ct=n=>{if(!n||n.length===0)return 0;let t=0;return n.forEach(i=>{const l=Number(i[0]??0),b=Number(i[1]??0);Number.isFinite(b)&&l!==0&&b>0&&(t+=1)}),t},lt=n=>{const{players:t,targets:i,skillMap:l,buffMap:b}=n,h=n.getPlayerKey||at,B=bn(b),k={},N={};t.forEach(g=>{if(g!=null&&g.notInSquad)return;const C=h(g);C&&(k[C]||(k[C]={}),g!=null&&g.totalDamageDist&&g.totalDamageDist.forEach(I=>{I&&I.forEach(d=>{if(!d.id)return;let M=`Skill ${d.id}`,P;l&&(l[`s${d.id}`]?(M=l[`s${d.id}`].name||M,P=l[`s${d.id}`].icon||P):l[`${d.id}`]&&(M=l[`${d.id}`].name||M,P=l[`${d.id}`].icon||P));const A=Je(M,d.id,b);if(!A)return;const R=b==null?void 0:b[`b${d.id}`],ae=R==null?void 0:R.name,q=B.get(A)||(R==null?void 0:R.icon),oe=M.startsWith("Skill ")?ae||A:M,z=P||(R==null?void 0:R.icon),_=Number(d.connectedHits??0),he=Number(d.hits??0),H=_>0?_:he,O=Number(d.totalDamage??0);if(!Number.isFinite(H)&&!Number.isFinite(O))return;const fe=N[A]||{name:A,icon:q,applications:0,damage:0};fe.applications+=Number.isFinite(H)?H:0,fe.damage+=Number.isFinite(O)?O:0,!fe.icon&&q&&(fe.icon=q),N[A]=fe;const Z=k[C][A]||{icon:q,applications:0,damage:0,skills:{}};Z.applications+=Number.isFinite(H)?H:0,Z.damage+=Number.isFinite(O)?O:0;const ce=Z.skills[oe]||{name:oe,hits:0,damage:0,icon:z};ce.hits+=Number.isFinite(H)?H:0,ce.damage+=Number.isFinite(O)?O:0,!ce.icon&&z&&(ce.icon=z),Z.skills[oe]=ce,!Z.icon&&q&&(Z.icon=q),k[C][A]=Z})}))});const ie=new Map;t.forEach(g=>{if(g!=null&&g.notInSquad)return;const C=h(g);C&&g!=null&&g.name&&ie.set(g.name,C)});let pe=0,U=0,y=0;return i.forEach(g=>{g!=null&&g.buffs&&g.buffs.forEach(C=>{const I=Number(C==null?void 0:C.id);if(!Number.isFinite(I))return;const d=b==null?void 0:b[`b${I}`];if((d==null?void 0:d.classification)!=="Condition")return;const M=(d==null?void 0:d.name)||Ge(d==null?void 0:d.name);if(!M)return;const P=C.statesPerSource||{};y+=1,Object.entries(P).forEach(([A,R])=>{var he;const ae=ie.get(A);if(!ae)return;U+=1;const q=rt(R),oe=ct(R);pe+=q;const z=((he=k[ae])==null?void 0:he[M])||{applications:0,damage:0,skills:{}};z.applicationsFromBuffs=(z.applicationsFromBuffs||0)+q,z.applicationsFromBuffsActive=(z.applicationsFromBuffsActive||0)+oe,k[ae]=k[ae]||{},k[ae][M]=z;const _=N[M]||{name:M,applications:0,damage:0};_.applicationsFromBuffs=(_.applicationsFromBuffs||0)+q,_.applicationsFromBuffsActive=(_.applicationsFromBuffsActive||0)+oe,N[M]=_})})}),Object.values(k).forEach(g=>{Object.values(g).forEach(C=>{typeof C.applicationsFromBuffs=="number"&&(C.applications=C.applicationsFromBuffs)})}),Object.values(N).forEach(g=>{typeof g.applicationsFromBuffs=="number"&&(g.applications=g.applicationsFromBuffs)}),{playerConditions:k,summary:N,meta:{buffStateApplicationsTotal:pe,targetBuffEntriesSeen:y,buffStateSourcesSeen:U}}},ut=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],dt=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],ft=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],mt=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],pt=new Set([10244]),gt=(n,t)=>{var b;if(pt.has(n))return!0;const i=(t==null?void 0:t[`s${n}`])||(t==null?void 0:t[`${n}`]),l=((b=i==null?void 0:i.name)==null?void 0:b.toLowerCase())||"";return mt.some(h=>l.includes(h))},bt=n=>{if(!n||!Number.isFinite(n))return"--:--";const t=Math.max(0,Math.round(n/1e3)),i=Math.floor(t/3600),l=Math.floor(t%3600/60),b=t%60;return i>0?`${i}:${String(l).padStart(2,"0")}:${String(b).padStart(2,"0")}`:`${l}:${String(b).padStart(2,"0")}`},en={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function hn(n){return en[n]||en.Unknown}const ht=n=>{if(n==null||n==="")return 0;if(typeof n=="number")return!Number.isFinite(n)||n<=0?0:n>1e12?n:n*1e3;if(n instanceof Date){const B=n.getTime();return Number.isFinite(B)&&B>0?B:0}const t=String(n).trim();if(!t)return 0;const i=Number(t);if(Number.isFinite(i)&&i>0)return i>1e12?i:i*1e3;const l=Date.parse(t);if(Number.isFinite(l)&&l>0)return l;const b=t.replace(/([+-]\d{2})$/,"$1:00"),h=Date.parse(b);return Number.isFinite(h)&&h>0?h:0},We=(n,t)=>ht((n==null?void 0:n.uploadTime)??(t==null?void 0:t.uploadTime)??(n==null?void 0:n.timeStartStd)??(n==null?void 0:n.timeStart)??(n==null?void 0:n.timeEndStd)??(n==null?void 0:n.timeEnd)??(n==null?void 0:n.timeStartText)??(n==null?void 0:n.timeEndText)),Ct=({logs:n,precomputedStats:t,mvpWeights:i,statsViewSettings:l,disruptionMethod:b})=>{const h=(()=>{const U=n.filter(y=>y.details&&y.details.players&&y.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:n.length,passed:U.length,statuses:n.map(y=>y.status),hasDetails:n.map(y=>!!y.details)}),U})(),B=l||st,k=i||ot,N=U=>{if(!U||typeof U!="object")return U;const y=Array.isArray(U.fightBreakdown)?U.fightBreakdown:null;if(!y||y.length===0)return U;const g=new Map,C=new Map;n.forEach(d=>{var A;const M=(d==null?void 0:d.filePath)||(d==null?void 0:d.id);M&&g.set(String(M),d);const P=(d==null?void 0:d.permalink)||((A=d==null?void 0:d.details)==null?void 0:A.permalink);typeof P=="string"&&P.trim()&&C.set(P.trim(),d)});const I=y.map(d=>{if(!d||typeof d!="object"||Number(d.timestamp)>0)return d;const P=d.id?String(d.id):"",A=typeof d.permalink=="string"?d.permalink.trim():"",R=(P?g.get(P):void 0)||(A?C.get(A):void 0);if(!R)return d;const ae=We(R==null?void 0:R.details,R);return ae?{...d,timestamp:ae}:d});return{...U,fightBreakdown:I}},ie=(()=>{if(t)return N(t);const U=b||tt,y=B.topSkillDamageSource||"target",g=B.topSkillsMetric||"damage",C=h.length;let I=0,d=0,M=0,P=0,A=0,R=0,ae=0,q=0;const oe=e=>{const o=((e==null?void 0:e.players)||[]).filter(F=>!F.notInSquad);let T=0,m=0,p=0,w=0;return o.forEach(F=>{var ee;const $=(ee=F.defenses)==null?void 0:ee[0];if(!$)return;const Q=Number($.downCount||0),re=Number($.deadCount||0);T+=Q+re,p+=re}),o.forEach(F=>{!F.statsTargets||F.statsTargets.length===0||F.statsTargets.forEach($=>{const Q=$==null?void 0:$[0];if(!Q)return;const re=Number(Q.downed||0),ee=Number(Q.killed||0);m+=re+ee,w+=ee})}),{squadDownsDeaths:T,enemyDownsDeaths:m,squadDeaths:p,enemyDeaths:w}},z=e=>{const{squadDownsDeaths:a,enemyDownsDeaths:o}=oe(e);return a>0||o>0?o>a:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},_=new Map,he=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),H={},O={},fe=new Map,Z={},ce={},J={},Be=new Map,Ee=new Map,Ye=new Set(Object.keys(en)),Qe=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],ze=e=>{if(!e)return"Unknown";const a=String(e).replace(/\s\d+$/,"");if(Ye.has(a))return a;const o=a.toLowerCase();return Qe.find(m=>o.includes(m.toLowerCase()))||a||"Unknown"},Tt=e=>e!=null&&e.classification?e.classification==="Boon":!0;console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:h.length}),h.forEach((e,a)=>{var L,V;const o=e.details;if(!o)return;const T=o.players;console.log(`[useStatsAggregation] Processing log ${a}:`,{playerCount:T==null?void 0:T.length,hasTargets:!!o.targets,firstPlayer:T!=null&&T[0]?{account:T[0].account,notInSquad:T[0].notInSquad}:"none"});const m=o.targets||[],p=o.combatReplayMetaData||{},w=(p==null?void 0:p.inchToPixel)>0?p.inchToPixel:1,F=(p==null?void 0:p.pollingRate)>0?p.pollingRate:1,$=5e3,Q=s=>Array.isArray(s)?s.map(S=>Array.isArray(S)?[Number(S[0]),Number(S[1])]:null).filter(S=>!!S&&Number.isFinite(S[0])):[];let re=[],ee=o.durationMS||0,Ne=!1;const be=T.find(s=>(s==null?void 0:s.hasCommanderTag)&&!(s!=null&&s.notInSquad));(L=be==null?void 0:be.combatReplayData)!=null&&L.positions&&(re=be.combatReplayData.positions,Q(be.combatReplayData.dead).forEach(([S])=>{S>0&&(Ne=!0,ee=Math.min(ee,S))}));const ve=s=>{var me;const S=(me=s.statsAll)==null?void 0:me[0];if((S==null?void 0:S.distToCom)!==void 0&&(S==null?void 0:S.distToCom)!=="Infinity")return Math.round(Number(S.distToCom));if((S==null?void 0:S.stackDist)!==void 0)return Math.round(Number(S.stackDist))||0;if(s.hasCommanderTag)return 0;const v=s.combatReplayData;if(!(v!=null&&v.positions)||!re.length)return 0;const ke=v.positions,f=Q(v.dead),G=Q(v.down),se=Math.floor((v.start||0)/F);let X=0;if(f.length&&G.length)for(const[le]of f){if(le<0)continue;const qe=Math.max(0,Math.floor(le/F))-se;for(const[we,Me]of G){if(le!==Me)continue;const Ae=Ne&&we>ee?Math.max(1,Math.floor(ee/F)):qe,ue=Math.max(0,Math.min(Ae,ke.length,re.length));if(ue<=0)continue;let Ce=0;for(let de=0;de<ue;de++){const[Le,Oe]=ke[de],[$e,xe]=re[de];Ce+=Math.hypot(Le-$e,Oe-xe)}X=Math.round(Ce/ue/w)}}return X},ne=T.filter(s=>!s.notInSquad),Re=T.filter(s=>s.notInSquad);M+=ne.length,P+=m.filter(s=>!s.isFake).length,nt(T,{durationMS:o.durationMS,buffMap:o.buffMap});const{squadDeaths:Ie,enemyDeaths:He}=oe(o);A+=Ie,R+=He,q+=Ie,ae+=He,z(o)?I++:d++;const x=o.skillMap?Number((V=Object.keys(o.skillMap).find(s=>{var S,v;return((v=(S=o.skillMap)==null?void 0:S[s])==null?void 0:v.name)==="Battle Standard"}))==null?void 0:V.replace(/^s/,"")):null;T.forEach(s=>{var Oe,$e,xe,Ke,vn,Bn,Nn,In,Pn,yn;if(s.notInSquad)return;const S=s.account||"Unknown",v=S!=="Unknown"?S:s.name||"Unknown",ke=s.name||"Unknown";_.has(v)||_.set(v,{name:ke,account:v,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:s.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const f=_.get(v);if(s.hasCommanderTag&&(f.isCommander=!0),s.profession&&s.profession!=="Unknown"){f.profession=s.profession,f.professions.add(s.profession);const r=Array.isArray(s.activeTimes)&&typeof s.activeTimes[0]=="number"?s.activeTimes[0]:o.durationMS||0;f.professionTimeMs[s.profession]=(f.professionTimeMs[s.profession]||0)+r}f.logsJoined++,f.downContrib+=Qn(s),f.cleanses+=Jn(s),f.strips+=Yn(s,U),f.healing+=Xn(s),f.barrier+=Zn(s),f.cc+=et(s,U),f.stab+=s.stabGeneration||0;const G=ve(s);G<=$&&(f.totalDist+=G,f.distCount++),(Oe=s.defenses)!=null&&Oe[0]&&(f.dodges+=s.defenses[0].dodgeCount||0,f.downs+=s.defenses[0].downCount||0,f.deaths+=s.defenses[0].deadCount||0),o.durationMS&&(f.totalFightMs+=o.durationMS);const se=Array.isArray(s.activeTimes)&&typeof s.activeTimes[0]=="number"?s.activeTimes[0]:o.durationMS||0;f.defenseActiveMs+=se,f.supportActiveMs+=se,f.healingActiveMs+=se,Array.isArray(s.buffUptimes)&&s.buffUptimes.length>0&&s.buffUptimes.forEach(r=>{var Rn,qn,Un,Ln;if(typeof(r==null?void 0:r.id)!="number")return;const c=`b${r.id}`,D=((Rn=o.buffMap)==null?void 0:Rn[c])||((qn=o.buffMap)==null?void 0:qn[String(r.id)]);if(!D||Tt(D))return;const W=Number(((Ln=(Un=r.buffData)==null?void 0:Un[0])==null?void 0:Ln.uptime)??0);if(!Number.isFinite(W)||W<=0)return;const te=(D==null?void 0:D.stacking)??!1,Pe=(te?W:W/100)*se;if(!Number.isFinite(Pe)||Pe<=0)return;Be.has(c)||Be.set(c,{name:D==null?void 0:D.name,stacking:te,icon:D==null?void 0:D.icon}),Ee.has(c)||Ee.set(c,new Map);const Ue=Ee.get(c),ye=f.account||s.account||s.name||"Unknown";let De=Ue.get(ye);De||(De={account:ye,profession:f.profession||s.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},Ue.set(ye,De));const Ve=s.profession||f.profession;Ve&&Ve!=="Unknown"&&(De.professions.add(Ve),De.professionTimeMs[Ve]=(De.professionTimeMs[Ve]||0)+se,De.profession=Ve),De.totalMs+=Pe,De.durationMs+=se}),($e=s.defenses)!=null&&$e[0]&&dt.forEach(r=>{const c=Number(s.defenses[0][r.field]??0);Number.isFinite(c)&&(f.defenseTotals[r.id]=(f.defenseTotals[r.id]||0)+c)}),(xe=s.support)!=null&&xe[0]&&ft.forEach(r=>{let c=Number(s.support[0][r.field]??0);Number.isFinite(c)&&(he.has(r.field)&&c>999999&&(c=0),f.supportTotals[r.id]=(f.supportTotals[r.id]||0)+c)});const X=(r,c)=>{Number.isFinite(c)&&(f.healingTotals[r]=(f.healingTotals[r]||0)+c)};if(Array.isArray(s.rotation)){let r=0;s.rotation.forEach(c=>{var W;if(!(c!=null&&c.id)||!gt(c.id,o.skillMap))return;const D=((W=c.skills)==null?void 0:W.length)||0;D>0&&(r+=D,X(`resUtility_s${c.id}`,D))}),r>0&&X("resUtility",r)}const me=(Ke=s.statsAll)==null?void 0:Ke[0],le=(vn=s.dpsAll)==null?void 0:vn[0],qe=(Bn=s.support)==null?void 0:Bn[0];if(ut.forEach(r=>{if(r.id==="downContributionPercent"||!r.field)return;let c=0,D=0;r.source==="dpsAll"&&le?c=Number(le[r.field]??0):r.source==="statsAll"&&me?(c=Number(me[r.field]??0),D=Number(me[r.denomField||r.weightField||"connectedDamageCount"]??0)):r.source==="support"&&qe?c=Number(qe[r.field]??0):s.statsTargets&&s.statsTargets.forEach(W=>{W!=null&&W[0]&&(c+=Number(W[0][r.field]??0),D+=Number(W[0][r.denomField||r.weightField||"connectedDamageCount"]??0))}),Number.isFinite(c)&&(f.offenseTotals[r.id]=(f.offenseTotals[r.id]||0)+c,r.isRate&&D>0&&(f.offenseRateWeights[r.id]=(f.offenseRateWeights[r.id]||0)+D))}),s.targetDamageDist&&Number.isFinite(x)){const r=s.targetDamageDist.flatMap(c=>c||[]).flatMap(c=>c||[]).reduce((c,D)=>D!=null&&D.id&&D.id===x?c+((D==null?void 0:D.connectedHits)||0):c,0);f.offenseTotals.battleStandardHits=(f.offenseTotals.battleStandardHits||0)+r}f.revives+=((In=(Nn=s.support)==null?void 0:Nn[0])==null?void 0:In.resurrects)||0,le&&(f.damage+=le.damage||0,f.dps+=le.dps||0);const we=r=>{var te,je,Pe,Ue;let c=`Skill ${r.id}`;const D=((te=o.skillMap)==null?void 0:te[`s${r.id}`])||((je=o.skillMap)==null?void 0:je[`${r.id}`]);let W=D==null?void 0:D.icon;if(D!=null&&D.name&&(c=D.name),c.startsWith("Skill ")){const ye=Je(c,r.id,o.buffMap);ye&&(c=ye,W=((Ue=(Pe=o.buffMap)==null?void 0:Pe[`b${r.id}`])==null?void 0:Ue.icon)||W)}return{name:c,icon:W}},Me=r=>{if(!(r!=null&&r.id))return;const{name:c,icon:D}=we(r);H[r.id]||(H[r.id]={name:c,icon:D,damage:0,hits:0,downContribution:0}),H[r.id].name.startsWith("Skill ")&&!c.startsWith("Skill ")&&(H[r.id].name=c),!H[r.id].icon&&D&&(H[r.id].icon=D),H[r.id].damage+=r.totalDamage,H[r.id].hits+=r.connectedHits,H[r.id].downContribution+=Number(r.downContribution||0)},Ae=s.account||s.name||"Unknown",ue=s.profession||"Unknown",Ce=`${Ae}|${ue}`;let de=fe.get(Ce);de||(de={key:Ce,account:Ae,displayName:Ae,profession:ue,professionList:[ue],totalFightMs:0,skills:new Map},fe.set(Ce,de)),de.professionList.includes(ue)||de.professionList.push(ue),de.totalFightMs+=o.durationMS||0;const Le=r=>{if(!(r!=null&&r.id))return;const{name:c,icon:D}=we(r),W=`s${r.id}`;let te=de.skills.get(W);te||(te={id:W,name:c,icon:D,damage:0,downContribution:0},de.skills.set(W,te)),te.name.startsWith("Skill ")&&!c.startsWith("Skill ")&&(te.name=c),!te.icon&&D&&(te.icon=D),te.damage+=Number(r.totalDamage||0),te.downContribution+=Number(r.downContribution||0)};y==="total"?(Pn=s.totalDamageDist)==null||Pn.forEach(r=>{r==null||r.forEach(c=>{Me(c),Le(c)})}):(yn=s.targetDamageDist)==null||yn.forEach(r=>{r==null||r.forEach(c=>{c==null||c.forEach(D=>{Me(D),Le(D)})})}),s.totalDamageTaken&&s.totalDamageTaken.forEach(r=>{r==null||r.forEach(c=>{var je,Pe,Ue,ye;if(!(c!=null&&c.id))return;let D=`Skill ${c.id}`;const W=((je=o.skillMap)==null?void 0:je[`s${c.id}`])||((Pe=o.skillMap)==null?void 0:Pe[`${c.id}`]);let te=W==null?void 0:W.icon;if(W!=null&&W.name&&(D=W.name),D.startsWith("Skill ")){const De=Je(D,c.id,o.buffMap);De&&(D=De,te=((ye=(Ue=o.buffMap)==null?void 0:Ue[`b${c.id}`])==null?void 0:ye.icon)||te)}O[c.id]||(O[c.id]={name:D,icon:te,damage:0,hits:0}),(!O[c.id].name.startsWith("Skill ")||D.startsWith("Skill "))&&(O[c.id].name=D),!O[c.id].icon&&te&&(O[c.id].icon=te),O[c.id].damage+=c.totalDamage,O[c.id].hits+=c.hits})})}),Re.forEach(s=>{const S=ze(s.profession||s.name);S&&(J[S]=(J[S]||0)+1)});const E=lt({players:T,targets:m,skillMap:o.skillMap,buffMap:o.buffMap,getPlayerKey:s=>s.account&&s.account!=="Unknown"?s.account:s.name||null}),K=bn(o.buffMap);Object.entries(E.playerConditions).forEach(([s,S])=>{const v=_.get(s);v&&Object.entries(S).forEach(([ke,f])=>{const G=v.outgoingConditions[ke]||{applications:0,damage:0,skills:{},icon:f.icon};G.applications+=Number(f.applications||0),G.damage+=Number(f.damage||0),f.applicationsFromBuffs&&(G.applicationsFromBuffs=(G.applicationsFromBuffs||0)+f.applicationsFromBuffs),f.applicationsFromBuffsActive&&(G.applicationsFromBuffsActive=(G.applicationsFromBuffsActive||0)+f.applicationsFromBuffsActive),Object.entries(f.skills||{}).forEach(([se,X])=>{const me=G.skills[se]||{name:X.name,hits:0,damage:0,icon:X.icon};me.hits+=Number(X.hits||0),me.damage+=Number(X.damage||0),!me.icon&&X.icon&&(me.icon=X.icon),G.skills[se]=me}),!G.icon&&f.icon&&(G.icon=f.icon),v.outgoingConditions[ke]=G})}),Object.entries(E.summary).forEach(([s,S])=>{const v=Z[s]||{name:S.name||s,icon:S.icon,applications:0,damage:0};v.applications+=Number(S.applications||0),v.damage+=Number(S.damage||0),S.applicationsFromBuffs&&(v.applicationsFromBuffs=(v.applicationsFromBuffs||0)+S.applicationsFromBuffs),S.applicationsFromBuffsActive&&(v.applicationsFromBuffsActive=(v.applicationsFromBuffsActive||0)+S.applicationsFromBuffsActive),!v.icon&&S.icon&&(v.icon=S.icon),Z[s]=v}),ne.forEach(s=>{const S=s.account&&s.account!=="Unknown"?s.account:s.name||"Unknown",v=_.get(S);!v||!s.totalDamageTaken||s.totalDamageTaken.forEach(ke=>ke==null?void 0:ke.forEach(f=>{var de,Le,Oe,$e,xe,Ke;if(!(f!=null&&f.id))return;let G=`Skill ${f.id}`;const se=((de=o.skillMap)==null?void 0:de[`s${f.id}`])||((Le=o.skillMap)==null?void 0:Le[`${f.id}`]);se!=null&&se.name&&(G=se.name);const X=Je(G,f.id,o.buffMap);if(!X)return;const me=($e=(Oe=o.buffMap)==null?void 0:Oe[`b${f.id}`])==null?void 0:$e.name,le=K.get(X)||((Ke=(xe=o.buffMap)==null?void 0:xe[`b${f.id}`])==null?void 0:Ke.icon),qe=(se==null?void 0:se.icon)||le;G.startsWith("Skill ")&&(me||X)&&(G=me||X);const we=Number(f.hits??0),Me=Number(f.totalDamage??0),Ae=ce[X]||{name:X,icon:le,applications:0,damage:0};Ae.applications+=Number.isFinite(we)?we:0,Ae.damage+=Number.isFinite(Me)?Me:0,!Ae.icon&&le&&(Ae.icon=le),ce[X]=Ae;const ue=v.incomingConditions[X]||{applications:0,damage:0,skills:{},icon:le};ue.applications+=Number.isFinite(we)?we:0,ue.damage+=Number.isFinite(Me)?Me:0;const Ce=ue.skills[G]||{name:G,hits:0,damage:0,icon:qe};Ce.hits+=Number.isFinite(we)?we:0,Ce.damage+=Number.isFinite(Me)?Me:0,!Ce.icon&&qe&&(Ce.icon=qe),ue.skills[G]=Ce,!ue.icon&&le&&(ue.icon=le),v.incomingConditions[X]=ue}))})});const St=C>0?Math.round(M/C):0,kt=C>0?Math.round(P/C):0,wt=A>0?(R/A).toFixed(2):R>0?"∞":"0.00",Mt=ae>0?(q/ae).toFixed(2):q>0?"∞":"0.00",wn=(e,a)=>{const T=e.filter(w=>Number.isFinite(w.value)&&(a?w.value>0:w.value>=0)).sort((w,F)=>{const $=a?F.value-w.value:w.value-F.value;return $!==0?$:w.account.localeCompare(F.account)});let m=null,p=0;return T.map((w,F)=>((m===null||w.value!==m)&&(p=F+1,m=w.value),{rank:p,...w}))},on=Array.from(_.values()).map(e=>{const a=Array.from(e.professions).filter(o=>o!=="Unknown");if(e.professionList=a,a.length>0){let o=a[0],T=e.professionTimeMs[o]||0;a.forEach(m=>{const p=e.professionTimeMs[m]||0;p>T&&(T=p,o=m)}),e.profession=o}return{key:e.account,stat:e}}),Xe=(e,a)=>{switch(a){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},ge=(e,a)=>wn(on.map(({stat:o})=>({account:o.account,profession:o.profession,professionList:o.professionList,value:Xe(o,e),count:o.logsJoined})),a),Y={downContrib:ge("downContrib",!0),barrier:ge("barrier",!0),healing:ge("healing",!0),dodges:ge("dodges",!0),strips:ge("strips",!0),cleanses:ge("cleanses",!0),cc:ge("cc",!0),stability:ge("stability",!0),revives:ge("revives",!0),participation:ge("participation",!0),dps:ge("dps",!0),damage:ge("damage",!0),closestToTag:ge("closestToTag",!1).filter(e=>Number.isFinite(e.value))},At={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},j=e=>{const a=e==null?void 0:e[0];return{value:(a==null?void 0:a.value)??0,player:(a==null?void 0:a.account)??"-",count:(a==null?void 0:a.count)??0,profession:(a==null?void 0:a.profession)??"Unknown",professionList:(a==null?void 0:a.professionList)??[]}},Fe={maxDownContrib:j([]),maxBarrier:j([]),maxHealing:j([]),maxDodges:j([]),maxStrips:j([]),maxCleanses:j([]),maxCC:j([]),maxStab:j([]),closestToTag:j([])},Se={},Et=(e,a)=>{if(a==="closestToTag")return Xe(e,a);const o=Math.max(1,(e.totalFightMs||0)/1e3);return Xe(e,a)/o};Object.values(At).forEach(e=>{const a=e!=="closestToTag";Se[e]=wn(on.map(({stat:o})=>({account:o.account,profession:o.profession,professionList:o.professionList,value:Et(o,e),count:o.logsJoined})),a)}),Fe.maxDownContrib=j(Se.downContrib),Fe.maxBarrier=j(Se.barrier),Fe.maxHealing=j(Se.healing),Fe.maxDodges=j(Se.dodges),Fe.maxStrips=j(Se.strips),Fe.maxCleanses=j(Se.cleanses),Fe.maxCC=j(Se.cc),Fe.maxStab=j(Se.stability),Fe.closestToTag=j(Se.closestToTag);const Ft={maxDownContrib:j(Y.downContrib),maxBarrier:j(Y.barrier),maxHealing:j(Y.healing),maxDodges:j(Y.dodges),maxStrips:j(Y.strips),maxCleanses:j(Y.cleanses),maxCC:j(Y.cc),maxStab:j(Y.stability),closestToTag:j(Y.closestToTag)};let sn={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},Mn,An,En=0;if(B!=null&&B.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},a=p=>{const w=e[p];return w?Number(k[w]||0)>0:!1},o=[],T=p=>[...p||[]].filter(w=>a(w==null?void 0:w.name)).sort((w,F)=>F.ratio-w.ratio||w.rank-F.rank||w.name.localeCompare(F.name)).slice(0,3),m=p=>{var F;if(!p)return;const w=T(p.contribs);return{...p,player:p.name,reason:((F=w[0])==null?void 0:F.name)||"Top Performance",topStats:w}};on.forEach(({stat:p})=>{let w=0;const F=[],$=(Q,re,ee,Ne,be=!0)=>{var ne,Re;if(ee<=0)return;const ve=((ne=re[0])==null?void 0:ne.value)||0;if(ve&&Number.isFinite(Q)&&(be?Q>0:Q<Number.POSITIVE_INFINITY)){const Ie=be?Q/ve:ve/Q;w+=Ie*ee;const He=((Re=re.find(u=>u.account===p.account))==null?void 0:Re.rank)||0;F.push({name:Ne,ratio:Ie,val:Q.toLocaleString(),rank:He})}};$(p.downContrib,Y.downContrib,k.downContribution,"Down Contribution"),$(p.healing,Y.healing,k.healing,"Healing"),$(p.cleanses,Y.cleanses,k.cleanses,"Cleanses"),$(p.strips,Y.strips,k.strips,"Strips"),$(p.stab,Y.stability,k.stability,"Stability"),$(p.cc,Y.cc,k.cc,"CC"),$(p.revives,Y.revives,k.revives,"Revives"),$(Xe(p,"closestToTag"),Y.closestToTag,k.distanceToTag,"Distance to Tag",!1),$(p.logsJoined,Y.participation,k.participation,"Participation"),$(p.dodges,Y.dodges,k.dodging,"Dodging"),$(p.dps,Y.dps,k.dps,"DPS"),$(p.damage,Y.damage,k.damage,"Damage"),o.push({...p,score:w,contribs:F.filter(Q=>a(Q.name))})}),o.sort((p,w)=>w.score-p.score),o[0]&&o[0].score>0&&(sn=m(o[0])||sn),Mn=m(o[1]),An=m(o[2]),En=o.length>0?o.reduce((p,w)=>p+w.score,0)/o.length:0}const vt=Object.values(H).sort((e,a)=>{const o=g==="downContribution"?e.downContribution:e.damage;return(g==="downContribution"?a.downContribution:a.damage)-o}).slice(0,25),Bt=Object.values(O).sort((e,a)=>a.damage-e.damage).slice(0,25),Nt=e=>{const a=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),o=a.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return o?`${o[1]} Borderlands`:a||"Unknown"},Fn=(e,a)=>Nt((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(a==null?void 0:a.fightName)||(a==null?void 0:a.encounterName)||"Unknown"),It=(e,a)=>{const o=(a==null?void 0:a.permalink)||(e==null?void 0:e.permalink);if(typeof o=="string"&&o.trim().length>0)return o.trim();const T=e==null?void 0:e.uploadLinks;if(!Array.isArray(T))return"";for(const m of T){if(typeof m=="string"&&m.trim().length>0)return m.trim();if(m&&typeof m=="object"){const p=m.permalink||m.link||m.url||m.reportLink;if(typeof p=="string"&&p.trim().length>0)return p.trim()}}return""},an={};h.forEach(e=>{const a=Fn(e==null?void 0:e.details,e);an[a]=(an[a]||0)+1});const Pt=Object.entries(an).map(([e,a])=>{const o=String(e).trim(),T=/eternal battlegrounds|^ebg$/i.test(o);let m="#64748b";return T?m="#ffffff":/red/i.test(o)?m="#ef4444":/blue/i.test(o)?m="#3b82f6":/green/i.test(o)&&(m="#22c55e"),{name:e,value:a,color:m}}).sort((e,a)=>a.value-e.value),{boonTables:yt}=$n(h),Rt=h.map((e,a)=>{var T,m;const o=((T=e.details)==null?void 0:T.players)||[];return{index:a+1,label:`Log ${a+1}`,timestamp:We(e.details,e),squadCount:o.filter(p=>!p.notInSquad).length,friendlyCount:o.length,enemies:((m=e.details)==null?void 0:m.targets).filter(p=>!p.isFake).length}}).sort((e,a)=>e.timestamp-a.timestamp),rn={};Array.from(_.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(rn[e.profession]=(rn[e.profession]||0)+1)});const qt=Object.entries(rn).map(([e,a])=>({name:e,value:a,color:hn(e)})).sort((e,a)=>a.value-e.value),cn={};Object.keys(J).length===0&&h.forEach(e=>{var a,o;(o=(a=e.details)==null?void 0:a.targets)==null||o.forEach(T=>{if(T.isFake)return;const m=T.profession&&T.profession!=="Unknown"?T.profession:T.name||T.id||"Unknown",p=ze(m);cn[p]=(cn[p]||0)+1})});const Ut=Object.keys(J).length>0?J:cn,Lt=Object.entries(Ut).map(([e,a])=>({name:e,value:a,color:hn(e)})).sort((e,a)=>a.value-e.value),Ot=h.map((e,a)=>({log:e,originalIndex:a})).sort((e,a)=>We(e.log.details,e.log)-We(a.log.details,a.log)).map(({log:e},a)=>{const o=e.details;if(!o)return null;const T=o.players||[],m=T.filter(u=>!u.notInSquad),p=T.filter(u=>u.notInSquad),w=o.targets||[],F=w.filter(u=>!u.isFake),$=m.reduce((u,x)=>{var E,K;return u+(((K=(E=x.dpsAll)==null?void 0:E[0])==null?void 0:K.damage)||0)},0),Q=m.reduce((u,x)=>{var E,K;return u+(((K=(E=x.defenses)==null?void 0:E[0])==null?void 0:K.damageTaken)||0)},0),{enemyDeaths:re,enemyDownsDeaths:ee}=oe(o),Ne=z(o),be=We(o,e),ve=Fn(o,e),ne={red:0,green:0,blue:0},Re=u=>{const x=Number(u);return Number.isFinite(x)?x:0},Ie=u=>{if(!u||typeof u!="object")return;const x=u.teamID??u.teamId??u.team??u.teamColor??u.team_color;if(x!=null)return x;const E=Object.keys(u).find(K=>/^team/i.test(K));return E?u[E]:void 0},He=(u,x)=>{if(u==null)return null;if(typeof u=="string"){const E=u.toLowerCase();return E.includes("red")?"red":E.includes("green")?"green":E.includes("blue")?"blue":E==="r"?"red":E==="g"?"green":E==="b"?"blue":null}if(typeof u=="number")if(x==="zeroBased"){if(u===0)return"red";if(u===1)return"green";if(u===2)return"blue"}else{if(u===1)return"red";if(u===2)return"green";if(u===3)return"blue"}return null};if(o.teamCounts&&typeof o.teamCounts=="object"){const u=o.teamCounts;ne.red=Re(u.red??u.r??u[0]??u[1]),ne.green=Re(u.green??u.g??u[1]??u[2]),ne.blue=Re(u.blue??u.b??u[2]??u[3])}else{const u=[];w.forEach(L=>{if(L!=null&&L.isFake)return;const V=Ie(L);V!=null&&u.push(V)}),T.forEach(L=>{if(!(L!=null&&L.notInSquad))return;const V=Ie(L);V!=null&&u.push(V)}),u.length===0&&T.forEach(L=>{const V=Ie(L);V!=null&&u.push(V)});const x=new Set;u.forEach(L=>{typeof L=="number"&&x.add(L)});const E=x.has(0)?"zeroBased":x.has(3)?"oneBased":"zeroBased";if(u.forEach(L=>{const V=He(L,E);V&&(ne[V]+=1)}),ne.red+ne.green+ne.blue===0&&u.length>0){const L=new Map;u.forEach(s=>{const S=String(s);L.set(S,(L.get(S)||0)+1)});const V=Array.from(L.values()).sort((s,S)=>S-s);ne.red=V[0]||0,ne.green=V[1]||0,ne.blue=V[2]||0}ne.red+ne.green+ne.blue===0&&(ne.red=Math.max(F.length,T.filter(L=>L==null?void 0:L.notInSquad).length))}return{id:e.filePath||`fight-${a}`,label:e.encounterName||`Fight ${a+1}`,permalink:It(o,e),timestamp:be,mapName:ve,duration:bt(o.durationMS),isWin:Ne,squadCount:m.length,allyCount:p.length,enemyCount:F.length,teamCounts:ne,alliesDown:m.reduce((u,x)=>{var E,K;return u+(((K=(E=x.defenses)==null?void 0:E[0])==null?void 0:K.downCount)||0)},0),alliesDead:m.reduce((u,x)=>{var E,K;return u+(((K=(E=x.defenses)==null?void 0:E[0])==null?void 0:K.deadCount)||0)},0),alliesRevived:m.reduce((u,x)=>{var E,K;return Number(((K=(E=x.statsAll)==null?void 0:E[0])==null?void 0:K.saved)||0)>0?u+1:u},0),rallies:0,enemyDeaths:re,enemyDowns:Math.max(0,ee-re),totalOutgoingDamage:$,totalIncomingDamage:Q,incomingBarrierAbsorbed:m.reduce((u,x)=>{var E,K;return u+(((K=(E=x.defenses)==null?void 0:E[0])==null?void 0:K.damageBarrier)||0)},0),outgoingBarrierAbsorbed:m.reduce((u,x)=>{var L;const E=(L=x.extBarrierStats)==null?void 0:L.outgoingBarrier;if(!Array.isArray(E))return u;let K=0;return E.forEach(V=>{if(Array.isArray(V)){V.forEach(s=>{K+=Number((s==null?void 0:s.barrier)||0)});return}K+=Number((V==null?void 0:V.barrier)||0)}),u+K},0)}}).filter(Boolean),$t=Array.from(Ee.entries()).map(([e,a])=>{const o=Be.get(e)||{},T=Array.from(a.values()).map(m=>{var re;const p=Array.from(m.professions||[]).filter(ee=>ee&&ee!=="Unknown");let w=m.profession||"Unknown";if(p.length>0){w=p[0];let ee=((re=m.professionTimeMs)==null?void 0:re[w])||0;p.forEach(Ne=>{var ve;const be=((ve=m.professionTimeMs)==null?void 0:ve[Ne])||0;be>ee&&(ee=be,w=Ne)})}const F=m.durationMs||0,$=m.totalMs/1e3,Q=F>0?m.totalMs/F:0;return{account:m.account,profession:w,professionList:p,total:$,perSecond:Q,duration:F/1e3}}).filter(m=>m.total>0||m.perSecond>0);return{id:e,name:o.name||e,icon:o.icon,rows:T}}).filter(e=>e.rows.length>0),xt=Array.from(fe.values()).map(e=>{const a=Array.from(e.skills.values()).sort((T,m)=>m.damage-T.damage),o=a.reduce((T,m)=>(T[m.id]=m,T),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:a,skillMap:o}}).sort((e,a)=>e.displayName.localeCompare(a.displayName));return{total:C,wins:I,losses:d,avgSquadSize:St,avgEnemies:kt,squadKDR:wt,enemyKDR:Mt,totalSquadKills:R,totalSquadDeaths:A,totalEnemyKills:q,totalEnemyDeaths:ae,leaderboards:Y,...Ft,outgoingConditionSummary:Object.values(Z).sort((e,a)=>a.damage-e.damage),incomingConditionSummary:Object.values(ce).sort((e,a)=>a.damage-e.damage),outgoingConditionPlayers:Array.from(_.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(_.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:vt,topIncomingSkills:Bt,playerSkillBreakdowns:xt,topSkillsMetric:g,mapData:Pt,timelineData:Rt,boonTables:yt,offensePlayers:Array.from(_.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(_.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),supportPlayers:Array.from(_.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(_.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:sn,silver:Mn,bronze:An,squadClassData:qt,enemyClassData:Lt,fightBreakdown:Ot,specialTables:$t,topStatsPerSecond:Fe,topStatsLeaderboardsPerSecond:Se,avgMvpScore:En}})(),pe=(()=>{const U=new Map,y=new Map,g=[],C=new Map,I=new Map;h.forEach(M=>{const P=M.details;if(!P)return;const A=P.skillMap||{},R=P.fightName||"Log",ae=We(P,M)||Date.now(),q={id:M.filePath||M.id||R,label:R,timestamp:ae,skillEntries:{},playerActiveSeconds:{},durationSeconds:P.durationMS?P.durationMS/1e3:0};(P.players||[]).forEach(z=>{if(z.notInSquad)return;const _=z.account||z.name||"Unknown",he=z.profession||"Unknown",H=`${_}|${he}`;let O=y.get(H);O||(O={key:H,account:_,displayName:_,profession:he,professionList:[he],logs:0,totalActiveSeconds:0,skillTotals:{}},y.set(H,O)),O.logs++;const fe=(Array.isArray(z.activeTimes)?z.activeTimes[0]:0)/1e3;O.totalActiveSeconds=(O.totalActiveSeconds||0)+fe,q.playerActiveSeconds[H]=fe,(z.rotation||[]).forEach(Z=>{var Ye,Qe,ze;if(!(Z!=null&&Z.id))return;const ce=((Ye=Z.skills)==null?void 0:Ye.length)||0;if(ce<=0)return;const J=`s${Z.id}`,Be=((Qe=A[J])==null?void 0:Qe.name)||`Skill ${Z.id}`,Ee=(ze=A[J])==null?void 0:ze.icon;O.skillTotals[J]=(O.skillTotals[J]||0)+ce,U.set(J,(U.get(J)||0)+ce),C.set(J,Be),Ee&&!I.has(J)&&I.set(J,Ee),q.skillEntries[J]||(q.skillEntries[J]={name:Be,icon:Ee,players:{}}),!q.skillEntries[J].icon&&Ee&&(q.skillEntries[J].icon=Ee),q.skillEntries[J].players[H]=(q.skillEntries[J].players[H]||0)+ce})}),g.push(q)});const d=Array.from(U.entries()).map(([M,P])=>({id:M,name:C.get(M)||M,total:P,icon:I.get(M)})).sort((M,P)=>P.total-M.total);return{logRecords:g,players:Array.from(y.values()),skillOptions:d,resUtilitySkills:[]}})();return{validLogs:h,stats:ie,skillUsageData:pe}};let Te=null,_e=!1,Cn=null,Dn=0,Tn=0,nn=null;const Sn=n=>{if(!n||typeof n!="object")return n;const t=(l,b)=>{const h={};return b.forEach(B=>{l&&Object.prototype.hasOwnProperty.call(l,B)&&(h[B]=l[B])}),h},i=t(n,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration"]);return Array.isArray(i.players)&&(i.players=i.players.map(l=>t(l,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","totalDamageTaken","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(i.targets)&&(i.targets=i.targets.map(l=>t(l,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer"]))),i},Dt=n=>{if(!n||typeof n!="object")return n;const t={...n};return n.details?t.details=Sn(n.details):t.details=Sn(n),t},kn=()=>{if(!_e||!Te)return;_e=!1,Dn+=1;const n=nn;nn=null;const t=Ct(Te);self.postMessage({type:"result",result:t,computeId:Dn,logCount:Te.logs.length,token:Tn,completedAt:Date.now(),flushId:n})},tn=()=>{Cn===null&&(Cn=setInterval(()=>{kn()},5e3))};self.onmessage=n=>{var i,l,b,h;const t=n.data;if((t==null?void 0:t.type)==="reset"){Te={logs:[]},typeof t.token=="number"&&(Tn=t.token),_e=!0,tn();return}if((t==null?void 0:t.type)==="settings"){Te={logs:(Te==null?void 0:Te.logs)||[],precomputedStats:(i=t.payload)==null?void 0:i.precomputedStats,mvpWeights:(l=t.payload)==null?void 0:l.mvpWeights,statsViewSettings:(b=t.payload)==null?void 0:b.statsViewSettings,disruptionMethod:(h=t.payload)==null?void 0:h.disruptionMethod},_e=!0,tn();return}if((t==null?void 0:t.type)==="log"){Te||(Te={logs:[]}),Te.logs.push(Dt(t.payload)),_e=!0,tn();return}(t==null?void 0:t.type)==="flush"&&(typeof t.flushId=="number"&&(nn=t.flushId),_e=!0,kn())}})();
