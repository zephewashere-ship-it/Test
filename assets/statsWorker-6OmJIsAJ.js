(function(){"use strict";const un=["selfBuffs","groupBuffs","squadBuffs"],dn=n=>n!=null&&n.classification?n.classification==="Boon":!0,fn=n=>`b${n}`,zn=(n,o)=>{const a=Array.isArray(n==null?void 0:n.activeTimes)?n.activeTimes:[],u=typeof a[0]=="number"?a[0]:0;return u>0?u:o},mn=(n,o,a,u,D,T,I)=>{const w=n==="selfBuffs"?1:Math.max(n==="groupBuffs"?T-1:I-1,0);return!w||!D?{generationMs:0,wastedMs:0}:o?{generationMs:a*D*w,wastedMs:u*D*w}:{generationMs:a/100*D*w,wastedMs:u/100*D*w}},Kn=n=>{const o=new Map,a=new Map;return n.forEach(T=>{const I=T.details;if(!I)return;const w=I.durationMS||0,P=I.buffMap||{};Object.entries(P).forEach(([C,S])=>{if(!o.has(C)){o.set(C,S);return}const y=o.get(C)||{},p={name:y.name||S.name,stacking:y.stacking??S.stacking,icon:y.icon||S.icon,classification:y.classification||S.classification};o.set(C,p)});const ue=(I.players||[]).filter(C=>!C.notInSquad),O=ue.length,U=new Map;ue.forEach(C=>{const S=C.group??0;U.set(S,(U.get(S)||0)+1)}),ue.forEach(C=>{const S=C.account||C.name||C.character_name||"Unknown",y=C.profession||"Unknown",p=C.group??0,F=U.get(p)||1,q=zn(C,w);a.has(S)||a.set(S,{account:S,profession:y,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const v=a.get(S);v.profession=y,y!=="Unknown"&&(v.professions.add(y),v.professionTimeMs[y]=(v.professionTimeMs[y]||0)+q),v.activeTimeMs+=q,v.numFights+=1,v.groupSupported+=F,v.squadSupported+=O,un.forEach(R=>{(C[R]||[]).forEach($=>{var Q,ie,K,Ne;if(typeof($==null?void 0:$.id)!="number")return;const ee=fn($.id),V=P[ee];if(!dn(V))return;const W=(V==null?void 0:V.stacking)??!1,me=((ie=(Q=$.buffData)==null?void 0:Q[0])==null?void 0:ie.generation)??0,_=((Ne=(K=$.buffData)==null?void 0:K[0])==null?void 0:Ne.wasted)??0,{generationMs:x,wastedMs:re}=mn(R,W,me,_,w,F,O);!x&&!re||(o.has(ee)||o.set(ee,V||{}),v.boons[ee]||(v.boons[ee]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),v.boons[ee][R].generationMs+=x,v.boons[ee][R].wastedMs+=re)})})})}),{boonTables:Array.from(o.keys()).filter(T=>dn(o.get(T))).map(T=>{const I=o.get(T)||{},w=[];return a.forEach(P=>{var C;const te=P.boons[T];if(!te||!un.some(S=>te[S].generationMs>0||te[S].wastedMs>0))return;const O=Array.from(P.professions||[]).filter(S=>S&&S!=="Unknown");let U=P.profession;if(O.length>0){U=O[0];let S=((C=P.professionTimeMs)==null?void 0:C[U])||0;O.forEach(y=>{var F;const p=((F=P.professionTimeMs)==null?void 0:F[y])||0;p>S&&(S=p,U=y)})}w.push({account:P.account,profession:U||"Unknown",professionList:O,activeTimeMs:P.activeTimeMs||1,numFights:P.numFights||1,groupSupported:P.groupSupported||1,squadSupported:P.squadSupported||1,categories:{selfBuffs:{...te.selfBuffs},groupBuffs:{...te.groupBuffs},squadBuffs:{...te.squadBuffs}}})}),{id:T,name:I.name||T,icon:I.icon,stacking:I.stacking??!1,rows:w}}).filter(T=>T.rows.length>0)}},gn=(n,o,a,u,D,T,I={})=>{var C,S,y,p;const P=((n==null?void 0:n[o])||[]).find(F=>F.id===a);if(!P)return{generationMs:0,wastedMs:0};const te=I[fn(a)],ue=(te==null?void 0:te.stacking)??!1,O=((S=(C=P.buffData)==null?void 0:C[0])==null?void 0:S.generation)??0,U=((p=(y=P.buffData)==null?void 0:y[0])==null?void 0:p.wasted)??0;return mn(o,ue,O,U,u,D,T)};var Gn={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Jn=Gn,Ze="count",Yn=n=>(n||0)/1e3,Qn=(n,o)=>{var D;if(!n)return 0;const a=(D=Jn.methods.tiered)==null?void 0:D.tiers;if(!a)return n;const u=o/Math.max(n,1);return u<=a.shortMs?n*a.weights.short:u<=a.mediumMs?n*a.weights.medium:n*a.weights.long},pn=(n,o,a)=>a==="duration"?Yn(o):a==="tiered"?Qn(n,o):n;function Xn(n,o=Ze){var T;const a=(T=n.statsAll)==null?void 0:T[0],u=Number((a==null?void 0:a.appliedCrowdControl)??0),D=Number((a==null?void 0:a.appliedCrowdControlDuration)??0);return pn(u,D,o)}function Zn(n,o){const a=(o==null?void 0:o.durationMS)||0,u=(o==null?void 0:o.buffMap)||{},D=n.filter(w=>!w.notInSquad),T=D.length,I=new Map;D.forEach(w=>{const P=w.group??0;I.set(P,(I.get(P)||0)+1)}),D.forEach(w=>{const P=I.get(w.group??0)||1,te=gn(w,"selfBuffs",1122,a,P,T,u),ue=gn(w,"squadBuffs",1122,a,P,T,u);w.stabGeneration=(te.generationMs+ue.generationMs)/1e3})}function et(n){if(!n.statsTargets)return 0;let o=0;for(const a of n.statsTargets)a&&a.length>0&&(o+=a[0].downContribution||0);return o}function nt(n){if(!n.extBarrierStats||!n.extBarrierStats.outgoingBarrierAllies)return 0;let o=0;for(const a of n.extBarrierStats.outgoingBarrierAllies)if(a)for(const u of a)u&&(o+=u.barrier||0);return o}function tt(n){if(!n.extHealingStats||!n.extHealingStats.outgoingHealingAllies)return 0;let o=0;for(const a of n.extHealingStats.outgoingHealingAllies)if(a)for(const u of a)u&&(o+=u.healing||0);return o}const ot=n=>{var o,a,u,D;return(((a=(o=n.support)==null?void 0:o[0])==null?void 0:a.condiCleanse)||0)+(((D=(u=n.support)==null?void 0:u[0])==null?void 0:D.condiCleanseSelf)||0)},st=(n,o=Ze)=>{var T;const a=(T=n.support)==null?void 0:T[0],u=Number((a==null?void 0:a.boonStrips)??0),D=Number((a==null?void 0:a.boonStripsTime)??0);return pn(u,D,o)},it=n=>et(n),at=n=>tt(n),rt=n=>nt(n),ct=(n,o=Ze)=>Xn(n,o),lt=(n,o)=>Zn(n,o),ut="count",dt={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},ft={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},bn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),mt={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},je=n=>{if(!n)return null;const o=n.trim().toLowerCase(),a=bn.get(o);if(a)return a;const u=o.split(/[^a-z]+/).filter(Boolean);for(const D of u){const T=bn.get(D);if(T)return T}return null},Cn=n=>{const o=new Map;return n&&(Object.values(n).forEach(a=>{if(!(a!=null&&a.icon)||!(a!=null&&a.name))return;const u=je(a.name);u&&(o.has(u)||o.set(u,a.icon))}),Object.entries(mt).forEach(([a,u])=>{o.has(a)||o.set(a,u)})),o},Ve=(n,o,a)=>{var u;if(o&&a){const D=(u=a[`b${o}`])==null?void 0:u.name,T=je(D);if(T)return T}return n?je(n):null},gt=n=>{const o=(n==null?void 0:n.account)||"Unknown";return o&&o!=="Unknown"?o:(n==null?void 0:n.name)||"Unknown"||null},pt=n=>{if(!n||n.length===0)return 0;let o=0,a=null;return n.forEach(u=>{const D=Number(u[1]??0);if(Number.isFinite(D)){if(a===null){a=D;return}D>a&&(o+=D-a),a=D}}),o},bt=n=>{if(!n||n.length===0)return 0;let o=0;return n.forEach(a=>{const u=Number(a[0]??0),D=Number(a[1]??0);Number.isFinite(D)&&u!==0&&D>0&&(o+=1)}),o},Ct=n=>{const{players:o,targets:a,skillMap:u,buffMap:D}=n,T=n.getPlayerKey||gt,I=Cn(D),w={},P={};o.forEach(C=>{if(C!=null&&C.notInSquad)return;const S=T(C);S&&(w[S]||(w[S]={}),C!=null&&C.totalDamageDist&&C.totalDamageDist.forEach(y=>{y&&y.forEach(p=>{if(!p.id)return;let F=`Skill ${p.id}`,q;u&&(u[`s${p.id}`]?(F=u[`s${p.id}`].name||F,q=u[`s${p.id}`].icon||q):u[`${p.id}`]&&(F=u[`${p.id}`].name||F,q=u[`${p.id}`].icon||q));const v=Ve(F,p.id,D);if(!v)return;const R=D==null?void 0:D[`b${p.id}`],oe=R==null?void 0:R.name,$=I.get(v)||(R==null?void 0:R.icon),ee=F.startsWith("Skill ")?oe||v:F,V=q||(R==null?void 0:R.icon),W=Number(p.connectedHits??0),me=Number(p.hits??0),_=W>0?W:me,x=Number(p.totalDamage??0);if(!Number.isFinite(_)&&!Number.isFinite(x))return;const re=P[v]||{name:v,icon:$,applications:0,damage:0};re.applications+=Number.isFinite(_)?_:0,re.damage+=Number.isFinite(x)?x:0,!re.icon&&$&&(re.icon=$),P[v]=re;const Q=w[S][v]||{icon:$,applications:0,damage:0,skills:{}};Q.applications+=Number.isFinite(_)?_:0,Q.damage+=Number.isFinite(x)?x:0;const ie=Q.skills[ee]||{name:ee,hits:0,damage:0,icon:V};ie.hits+=Number.isFinite(_)?_:0,ie.damage+=Number.isFinite(x)?x:0,!ie.icon&&V&&(ie.icon=V),Q.skills[ee]=ie,!Q.icon&&$&&(Q.icon=$),w[S][v]=Q})}))});const te=new Map;o.forEach(C=>{if(C!=null&&C.notInSquad)return;const S=T(C);S&&C!=null&&C.name&&te.set(C.name,S)});let ue=0,O=0,U=0;return a.forEach(C=>{C!=null&&C.buffs&&C.buffs.forEach(S=>{const y=Number(S==null?void 0:S.id);if(!Number.isFinite(y))return;const p=D==null?void 0:D[`b${y}`];if((p==null?void 0:p.classification)!=="Condition")return;const F=(p==null?void 0:p.name)||je(p==null?void 0:p.name);if(!F)return;const q=S.statesPerSource||{};U+=1,Object.entries(q).forEach(([v,R])=>{var me;const oe=te.get(v);if(!oe)return;O+=1;const $=pt(R),ee=bt(R);ue+=$;const V=((me=w[oe])==null?void 0:me[F])||{applications:0,damage:0,skills:{}};V.applicationsFromBuffs=(V.applicationsFromBuffs||0)+$,V.applicationsFromBuffsActive=(V.applicationsFromBuffsActive||0)+ee,w[oe]=w[oe]||{},w[oe][F]=V;const W=P[F]||{name:F,applications:0,damage:0};W.applicationsFromBuffs=(W.applicationsFromBuffs||0)+$,W.applicationsFromBuffsActive=(W.applicationsFromBuffsActive||0)+ee,P[F]=W})})}),Object.values(w).forEach(C=>{Object.values(C).forEach(S=>{typeof S.applicationsFromBuffs=="number"&&(S.applications=S.applicationsFromBuffs)})}),Object.values(P).forEach(C=>{typeof C.applicationsFromBuffs=="number"&&(C.applications=C.applicationsFromBuffs)}),{playerConditions:w,summary:P,meta:{buffStateApplicationsTotal:ue,targetBuffEntriesSeen:U,buffStateSourcesSeen:O}}},ht=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],Dt=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],Tt=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],St=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],kt=new Set([10244]),wt=(n,o)=>{var D;if(kt.has(n))return!0;const a=(o==null?void 0:o[`s${n}`])||(o==null?void 0:o[`${n}`]),u=((D=a==null?void 0:a.name)==null?void 0:D.toLowerCase())||"";return St.some(T=>u.includes(T))},Mt=n=>{if(!n||!Number.isFinite(n))return"--:--";const o=Math.max(0,Math.round(n/1e3)),a=Math.floor(o/3600),u=Math.floor(o%3600/60),D=o%60;return a>0?`${a}:${String(u).padStart(2,"0")}:${String(D).padStart(2,"0")}`:`${u}:${String(D).padStart(2,"0")}`},ze={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function hn(n){return ze[n]||ze.Unknown}const At=n=>{if(n==null||n==="")return 0;if(typeof n=="number")return!Number.isFinite(n)||n<=0?0:n>1e12?n:n*1e3;if(n instanceof Date){const I=n.getTime();return Number.isFinite(I)&&I>0?I:0}const o=String(n).trim();if(!o)return 0;const a=Number(o);if(Number.isFinite(a)&&a>0)return a>1e12?a:a*1e3;const u=Date.parse(o);if(Number.isFinite(u)&&u>0)return u;const D=o.replace(/([+-]\d{2})$/,"$1:00"),T=Date.parse(D);return Number.isFinite(T)&&T>0?T:0},Oe=(n,o)=>At((n==null?void 0:n.uploadTime)??(o==null?void 0:o.uploadTime)??(n==null?void 0:n.timeStartStd)??(n==null?void 0:n.timeStart)??(n==null?void 0:n.timeEndStd)??(n==null?void 0:n.timeEnd)??(n==null?void 0:n.timeStartText)??(n==null?void 0:n.timeEndText)),Et=({logs:n,precomputedStats:o,mvpWeights:a,statsViewSettings:u,disruptionMethod:D})=>{const T=(()=>{const O=n.filter(U=>U.details&&U.details.players&&U.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:n.length,passed:O.length,statuses:n.map(U=>U.status),hasDetails:n.map(U=>!!U.details)}),O})(),I=u||ft,w=a||dt,P=O=>{if(!O||typeof O!="object")return O;const U=Array.isArray(O.fightBreakdown)?O.fightBreakdown:null;if(!U||U.length===0)return O;const C=new Map,S=new Map;n.forEach(p=>{var v;const F=(p==null?void 0:p.filePath)||(p==null?void 0:p.id);F&&C.set(String(F),p);const q=(p==null?void 0:p.permalink)||((v=p==null?void 0:p.details)==null?void 0:v.permalink);typeof q=="string"&&q.trim()&&S.set(q.trim(),p)});const y=U.map(p=>{if(!p||typeof p!="object"||Number(p.timestamp)>0)return p;const q=p.id?String(p.id):"",v=typeof p.permalink=="string"?p.permalink.trim():"",R=(q?C.get(q):void 0)||(v?S.get(v):void 0);if(!R)return p;const oe=Oe(R==null?void 0:R.details,R);return oe?{...p,timestamp:oe}:p});return{...O,fightBreakdown:y}},te=(()=>{if(o)return P(o);const O=D||ut,U=I.topSkillDamageSource||"target",C=I.topSkillsMetric||"damage",S=T.length;let y=0,p=0,F=0,q=0,v=0,R=0,oe=0,$=0;const ee=e=>{const s=((e==null?void 0:e.players)||[]).filter(N=>!N.notInSquad);let k=0,f=0,b=0,M=0;return s.forEach(N=>{var X;const H=(X=N.defenses)==null?void 0:X[0];if(!H)return;const Y=Number(H.downCount||0),se=Number(H.deadCount||0);k+=Y+se,b+=se}),s.forEach(N=>{!N.statsTargets||N.statsTargets.length===0||N.statsTargets.forEach(H=>{const Y=H==null?void 0:H[0];if(!Y)return;const se=Number(Y.downed||0),X=Number(Y.killed||0);f+=se+X,M+=X})}),{squadDownsDeaths:k,enemyDownsDeaths:f,squadDeaths:b,enemyDeaths:M}},V=e=>{const{squadDownsDeaths:i,enemyDownsDeaths:s}=ee(e);return i>0||s>0?s>i:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},W=new Map,me=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),_={},x={},re=new Map,Q={},ie={},K={},Ne=new Map,we=new Map,Ke=new Set(Object.keys(ze)),Ge=Object.keys(ze).filter(e=>e&&e!=="Unknown").sort((e,i)=>i.length-e.length),Je=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],tn=e=>{if(!e)return"Unknown";const i=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Ke.has(i))return i;const s=i.toLowerCase();for(const f of Ge)if(s.includes(f.toLowerCase()))return f;return Je.find(f=>s.includes(f.toLowerCase()))||i||"Unknown"},vt=e=>e!=null&&e.classification?e.classification==="Boon":!0;console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:T.length}),T.forEach((e,i)=>{var c,L;const s=e.details;if(!s)return;const k=s.players;console.log(`[useStatsAggregation] Processing log ${i}:`,{playerCount:k==null?void 0:k.length,hasTargets:!!s.targets,firstPlayer:k!=null&&k[0]?{account:k[0].account,notInSquad:k[0].notInSquad}:"none"});const f=s.targets||[],b=s.combatReplayMetaData||{},M=(b==null?void 0:b.inchToPixel)>0?b.inchToPixel:1,N=(b==null?void 0:b.pollingRate)>0?b.pollingRate:1,H=5e3,Y=t=>Array.isArray(t)?t.map(d=>Array.isArray(d)?[Number(d[0]),Number(d[1])]:null).filter(d=>!!d&&Number.isFinite(d[0])):[];let se=[],X=s.durationMS||0,Be=!1;const fe=k.find(t=>(t==null?void 0:t.hasCommanderTag)&&!(t!=null&&t.notInSquad));(c=fe==null?void 0:fe.combatReplayData)!=null&&c.positions&&(se=fe.combatReplayData.positions,Y(fe.combatReplayData.dead).forEach(([d])=>{d>0&&(Be=!0,X=Math.min(X,d))}));const Ae=t=>{var ne;const d=(ne=t.statsAll)==null?void 0:ne[0];if((d==null?void 0:d.distToCom)!==void 0&&(d==null?void 0:d.distToCom)!=="Infinity")return Math.round(Number(d.distToCom));if((d==null?void 0:d.stackDist)!==void 0)return Math.round(Number(d.stackDist))||0;if(t.hasCommanderTag)return 0;const h=t.combatReplayData;if(!(h!=null&&h.positions)||!se.length)return 0;const A=h.positions,B=Y(h.dead),g=Y(h.down),ce=Math.floor((h.start||0)/N);let z=0;if(B.length&&g.length)for(const[le]of B){if(le<0)continue;const Pe=Math.max(0,Math.floor(le/N))-ce;for(const[he,De]of g){if(le!==De)continue;const Te=Be&&he>X?Math.max(1,Math.floor(X/N)):Pe,ae=Math.max(0,Math.min(Te,A.length,se.length));if(ae<=0)continue;let Se=0;for(let Ee=0;Ee<ae;Ee++){const[Le,Re]=A[Ee],[Fe,$e]=se[Ee];Se+=Math.hypot(Le-Fe,Re-$e)}z=Math.round(Se/ae/M)}}return z},Z=k.filter(t=>!t.notInSquad),Ue=k.filter(t=>t.notInSquad);F+=Z.length,q+=f.filter(t=>!t.isFake).length,lt(k,{durationMS:s.durationMS,buffMap:s.buffMap});const{squadDeaths:Ie,enemyDeaths:He}=ee(s);v+=Ie,R+=He,$+=Ie,oe+=He,V(s)?y++:p++;const Qe=s.skillMap?Number((L=Object.keys(s.skillMap).find(t=>{var d,h;return((h=(d=s.skillMap)==null?void 0:d[t])==null?void 0:h.name)==="Battle Standard"}))==null?void 0:L.replace(/^s/,"")):null;k.forEach((t,d)=>{var Bn,In,Pn,yn,qn,Un,Rn,$n,Ln,On,xn,Hn;if(t.notInSquad)return;const h=t.account||"Unknown",A=h!=="Unknown"?h:t.name||"Unknown",B=t.name||"Unknown";W.has(A)||W.set(A,{name:B,account:A,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:t.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const g=W.get(A);if(t.hasCommanderTag&&(g.isCommander=!0),t.profession&&t.profession!=="Unknown"){g.profession=t.profession,g.professions.add(t.profession);const r=Array.isArray(t.activeTimes)&&typeof t.activeTimes[0]=="number"?t.activeTimes[0]:s.durationMS||0;g.professionTimeMs[t.profession]=(g.professionTimeMs[t.profession]||0)+r}g.logsJoined++,g.downContrib+=it(t),g.cleanses+=ot(t),g.strips+=st(t,O),g.healing+=at(t),g.barrier+=rt(t),g.cc+=ct(t,O),g.stab+=t.stabGeneration||0;const ce=Ae(t);ce<=H&&(g.totalDist+=ce,g.distCount++),(Bn=t.defenses)!=null&&Bn[0]&&(g.dodges+=t.defenses[0].dodgeCount||0,g.downs+=t.defenses[0].downCount||0,g.deaths+=t.defenses[0].deadCount||0),s.durationMS&&(g.totalFightMs+=s.durationMS);const z=Array.isArray(t.activeTimes)&&typeof t.activeTimes[0]=="number"?t.activeTimes[0]:s.durationMS||0;g.defenseActiveMs+=z,g.supportActiveMs+=z,g.healingActiveMs+=z,Array.isArray(t.buffUptimes)&&t.buffUptimes.length>0&&t.buffUptimes.forEach(r=>{var Wn,_n,jn,Vn;if(typeof(r==null?void 0:r.id)!="number")return;const l=`b${r.id}`,m=((Wn=s.buffMap)==null?void 0:Wn[l])||((_n=s.buffMap)==null?void 0:_n[String(r.id)]);if(!m||vt(m))return;const E=Number(((Vn=(jn=r.buffData)==null?void 0:jn[0])==null?void 0:Vn.uptime)??0);if(!Number.isFinite(E)||E<=0)return;const G=(m==null?void 0:m.stacking)??!1,ge=(G?E:E/100)*z;if(!Number.isFinite(ge)||ge<=0)return;Ne.has(l)||Ne.set(l,{name:m==null?void 0:m.name,stacking:G,icon:m==null?void 0:m.icon}),we.has(l)||we.set(l,new Map);const ve=we.get(l),qe=g.account||t.account||t.name||"Unknown";let pe=ve.get(qe);pe||(pe={account:qe,profession:g.profession||t.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},ve.set(qe,pe));const _e=t.profession||g.profession;_e&&_e!=="Unknown"&&(pe.professions.add(_e),pe.professionTimeMs[_e]=(pe.professionTimeMs[_e]||0)+z,pe.profession=_e),pe.totalMs+=ge,pe.durationMs+=z}),(In=t.defenses)!=null&&In[0]&&Dt.forEach(r=>{const l=Number(t.defenses[0][r.field]??0);Number.isFinite(l)&&(g.defenseTotals[r.id]=(g.defenseTotals[r.id]||0)+l)}),(Pn=t.support)!=null&&Pn[0]&&Tt.forEach(r=>{let l=Number(t.support[0][r.field]??0);Number.isFinite(l)&&(me.has(r.field)&&l>999999&&(l=0),g.supportTotals[r.id]=(g.supportTotals[r.id]||0)+l)});const ne=(r,l)=>{Number.isFinite(l)&&(g.healingTotals[r]=(g.healingTotals[r]||0)+l)},le=(r,l)=>Array.isArray(r)?r.reduce((m,E)=>m+Number((E==null?void 0:E[l])??0),0):0,Pe=(r,l,m)=>{if(!Number.isFinite(m)||m<=0)return;const E=k[l],G=l===d,ye=E==null?void 0:E.notInSquad,ge=!ye,ve=ge&&(E==null?void 0:E.group)!=null&&E.group===t.group;ne(r,m),ge&&ne(`squad${r[0].toUpperCase()}${r.slice(1)}`,m),ve&&ne(`group${r[0].toUpperCase()}${r.slice(1)}`,m),G&&ne(`self${r[0].toUpperCase()}${r.slice(1)}`,m),ye&&ne(`offSquad${r[0].toUpperCase()}${r.slice(1)}`,m)};if(Array.isArray(t.rotation)){let r=0;t.rotation.forEach(l=>{var E;if(!(l!=null&&l.id)||!wt(l.id,s.skillMap))return;const m=((E=l.skills)==null?void 0:E.length)||0;m>0&&(r+=m,ne(`resUtility_s${l.id}`,m))}),r>0&&ne("resUtility",r)}const he=(yn=t.extHealingStats)==null?void 0:yn.outgoingHealingAllies;Array.isArray(he)&&he.forEach((r,l)=>{const m=le(r,"healing"),E=le(r,"downedHealing");Pe("healing",l,m),Pe("downedHealing",l,E)});const De=(qn=t.extBarrierStats)==null?void 0:qn.outgoingBarrierAllies;Array.isArray(De)&&De.forEach((r,l)=>{const m=le(r,"barrier");Pe("barrier",l,m)});const Te=(Un=t.statsAll)==null?void 0:Un[0],ae=(Rn=t.dpsAll)==null?void 0:Rn[0],Se=($n=t.support)==null?void 0:$n[0];if(ht.forEach(r=>{if(r.id==="downContributionPercent"||!r.field)return;let l=0,m=0;r.source==="dpsAll"&&ae?l=Number(ae[r.field]??0):r.source==="statsAll"&&Te?(l=Number(Te[r.field]??0),m=Number(Te[r.denomField||r.weightField||"connectedDamageCount"]??0)):r.source==="support"&&Se?l=Number(Se[r.field]??0):t.statsTargets&&t.statsTargets.forEach(E=>{E!=null&&E[0]&&(l+=Number(E[0][r.field]??0),m+=Number(E[0][r.denomField||r.weightField||"connectedDamageCount"]??0))}),Number.isFinite(l)&&(g.offenseTotals[r.id]=(g.offenseTotals[r.id]||0)+l,r.isRate&&m>0&&(g.offenseRateWeights[r.id]=(g.offenseRateWeights[r.id]||0)+m))}),t.targetDamageDist&&Number.isFinite(Qe)){const r=t.targetDamageDist.flatMap(l=>l||[]).flatMap(l=>l||[]).reduce((l,m)=>m!=null&&m.id&&m.id===Qe?l+((m==null?void 0:m.connectedHits)||0):l,0);g.offenseTotals.battleStandardHits=(g.offenseTotals.battleStandardHits||0)+r}g.revives+=((On=(Ln=t.support)==null?void 0:Ln[0])==null?void 0:On.resurrects)||0,ae&&(g.damage+=ae.damage||0,g.dps+=ae.dps||0);const Ee=r=>{var G,ye,ge,ve;let l=`Skill ${r.id}`;const m=((G=s.skillMap)==null?void 0:G[`s${r.id}`])||((ye=s.skillMap)==null?void 0:ye[`${r.id}`]);let E=m==null?void 0:m.icon;if(m!=null&&m.name&&(l=m.name),l.startsWith("Skill ")){const qe=Ve(l,r.id,s.buffMap);qe&&(l=qe,E=((ve=(ge=s.buffMap)==null?void 0:ge[`b${r.id}`])==null?void 0:ve.icon)||E)}return{name:l,icon:E}},Le=r=>{if(!(r!=null&&r.id))return;const{name:l,icon:m}=Ee(r);_[r.id]||(_[r.id]={name:l,icon:m,damage:0,hits:0,downContribution:0}),_[r.id].name.startsWith("Skill ")&&!l.startsWith("Skill ")&&(_[r.id].name=l),!_[r.id].icon&&m&&(_[r.id].icon=m),_[r.id].damage+=r.totalDamage,_[r.id].hits+=r.connectedHits,_[r.id].downContribution+=Number(r.downContribution||0)},Re=t.account||t.name||"Unknown",Fe=t.profession||"Unknown",$e=`${Re}|${Fe}`;let ke=re.get($e);ke||(ke={key:$e,account:Re,displayName:Re,profession:Fe,professionList:[Fe],totalFightMs:0,skills:new Map},re.set($e,ke)),ke.professionList.includes(Fe)||ke.professionList.push(Fe),ke.totalFightMs+=s.durationMS||0;const Nn=r=>{if(!(r!=null&&r.id))return;const{name:l,icon:m}=Ee(r),E=`s${r.id}`;let G=ke.skills.get(E);G||(G={id:E,name:l,icon:m,damage:0,downContribution:0},ke.skills.set(E,G)),G.name.startsWith("Skill ")&&!l.startsWith("Skill ")&&(G.name=l),!G.icon&&m&&(G.icon=m),G.damage+=Number(r.totalDamage||0),G.downContribution+=Number(r.downContribution||0)};U==="total"?(xn=t.totalDamageDist)==null||xn.forEach(r=>{r==null||r.forEach(l=>{Le(l),Nn(l)})}):(Hn=t.targetDamageDist)==null||Hn.forEach(r=>{r==null||r.forEach(l=>{l==null||l.forEach(m=>{Le(m),Nn(m)})})}),t.totalDamageTaken&&t.totalDamageTaken.forEach(r=>{r==null||r.forEach(l=>{var ye,ge,ve,qe;if(!(l!=null&&l.id))return;let m=`Skill ${l.id}`;const E=((ye=s.skillMap)==null?void 0:ye[`s${l.id}`])||((ge=s.skillMap)==null?void 0:ge[`${l.id}`]);let G=E==null?void 0:E.icon;if(E!=null&&E.name&&(m=E.name),m.startsWith("Skill ")){const pe=Ve(m,l.id,s.buffMap);pe&&(m=pe,G=((qe=(ve=s.buffMap)==null?void 0:ve[`b${l.id}`])==null?void 0:qe.icon)||G)}x[l.id]||(x[l.id]={name:m,icon:G,damage:0,hits:0}),(!x[l.id].name.startsWith("Skill ")||m.startsWith("Skill "))&&(x[l.id].name=m),!x[l.id].icon&&G&&(x[l.id].icon=G),x[l.id].damage+=l.totalDamage,x[l.id].hits+=l.hits})})}),Ue.forEach(t=>{const d=tn(t.profession||t.name);d&&(K[d]=(K[d]||0)+1)});const Xe=Ct({players:k,targets:f,skillMap:s.skillMap,buffMap:s.buffMap,getPlayerKey:t=>t.account&&t.account!=="Unknown"?t.account:t.name||null}),ln=Cn(s.buffMap);Object.entries(Xe.playerConditions).forEach(([t,d])=>{const h=W.get(t);h&&Object.entries(d).forEach(([A,B])=>{const g=h.outgoingConditions[A]||{applications:0,damage:0,skills:{},icon:B.icon};g.applications+=Number(B.applications||0),g.damage+=Number(B.damage||0),B.applicationsFromBuffs&&(g.applicationsFromBuffs=(g.applicationsFromBuffs||0)+B.applicationsFromBuffs),B.applicationsFromBuffsActive&&(g.applicationsFromBuffsActive=(g.applicationsFromBuffsActive||0)+B.applicationsFromBuffsActive),Object.entries(B.skills||{}).forEach(([ce,z])=>{const ne=g.skills[ce]||{name:z.name,hits:0,damage:0,icon:z.icon};ne.hits+=Number(z.hits||0),ne.damage+=Number(z.damage||0),!ne.icon&&z.icon&&(ne.icon=z.icon),g.skills[ce]=ne}),!g.icon&&B.icon&&(g.icon=B.icon),h.outgoingConditions[A]=g})}),Object.entries(Xe.summary).forEach(([t,d])=>{const h=Q[t]||{name:d.name||t,icon:d.icon,applications:0,damage:0};h.applications+=Number(d.applications||0),h.damage+=Number(d.damage||0),d.applicationsFromBuffs&&(h.applicationsFromBuffs=(h.applicationsFromBuffs||0)+d.applicationsFromBuffs),d.applicationsFromBuffsActive&&(h.applicationsFromBuffsActive=(h.applicationsFromBuffsActive||0)+d.applicationsFromBuffsActive),!h.icon&&d.icon&&(h.icon=d.icon),Q[t]=h}),Z.forEach(t=>{const d=t.account&&t.account!=="Unknown"?t.account:t.name||"Unknown",h=W.get(d);!h||!t.totalDamageTaken||t.totalDamageTaken.forEach(A=>A==null?void 0:A.forEach(B=>{var Ee,Le,Re,Fe,$e,ke;if(!(B!=null&&B.id))return;let g=`Skill ${B.id}`;const ce=((Ee=s.skillMap)==null?void 0:Ee[`s${B.id}`])||((Le=s.skillMap)==null?void 0:Le[`${B.id}`]);ce!=null&&ce.name&&(g=ce.name);const z=Ve(g,B.id,s.buffMap);if(!z)return;const ne=(Fe=(Re=s.buffMap)==null?void 0:Re[`b${B.id}`])==null?void 0:Fe.name,le=ln.get(z)||((ke=($e=s.buffMap)==null?void 0:$e[`b${B.id}`])==null?void 0:ke.icon),Pe=(ce==null?void 0:ce.icon)||le;g.startsWith("Skill ")&&(ne||z)&&(g=ne||z);const he=Number(B.hits??0),De=Number(B.totalDamage??0),Te=ie[z]||{name:z,icon:le,applications:0,damage:0};Te.applications+=Number.isFinite(he)?he:0,Te.damage+=Number.isFinite(De)?De:0,!Te.icon&&le&&(Te.icon=le),ie[z]=Te;const ae=h.incomingConditions[z]||{applications:0,damage:0,skills:{},icon:le};ae.applications+=Number.isFinite(he)?he:0,ae.damage+=Number.isFinite(De)?De:0;const Se=ae.skills[g]||{name:g,hits:0,damage:0,icon:Pe};Se.hits+=Number.isFinite(he)?he:0,Se.damage+=Number.isFinite(De)?De:0,!Se.icon&&Pe&&(Se.icon=Pe),ae.skills[g]=Se,!ae.icon&&le&&(ae.icon=le),h.incomingConditions[z]=ae}))})});const Nt=S>0?Math.round(F/S):0,Bt=S>0?Math.round(q/S):0,It=v>0?(R/v).toFixed(2):R>0?"∞":"0.00",Pt=oe>0?($/oe).toFixed(2):$>0?"∞":"0.00",Mn=(e,i)=>{const k=e.filter(M=>Number.isFinite(M.value)&&(i?M.value>0:M.value>=0)).sort((M,N)=>{const H=i?N.value-M.value:M.value-N.value;return H!==0?H:M.account.localeCompare(N.account)});let f=null,b=0;return k.map((M,N)=>((f===null||M.value!==f)&&(b=N+1,f=M.value),{rank:b,...M}))},on=Array.from(W.values()).map(e=>{const i=Array.from(e.professions).filter(s=>s!=="Unknown");if(e.professionList=i,i.length>0){let s=i[0],k=e.professionTimeMs[s]||0;i.forEach(f=>{const b=e.professionTimeMs[f]||0;b>k&&(k=b,s=f)}),e.profession=s}return{key:e.account,stat:e}}),Ye=(e,i)=>{switch(i){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},de=(e,i)=>Mn(on.map(({stat:s})=>({account:s.account,profession:s.profession,professionList:s.professionList,value:Ye(s,e),count:s.logsJoined})),i),J={downContrib:de("downContrib",!0),barrier:de("barrier",!0),healing:de("healing",!0),dodges:de("dodges",!0),strips:de("strips",!0),cleanses:de("cleanses",!0),cc:de("cc",!0),stability:de("stability",!0),revives:de("revives",!0),participation:de("participation",!0),dps:de("dps",!0),damage:de("damage",!0),closestToTag:de("closestToTag",!1).filter(e=>Number.isFinite(e.value))},yt={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},j=e=>{const i=e==null?void 0:e[0];return{value:(i==null?void 0:i.value)??0,player:(i==null?void 0:i.account)??"-",count:(i==null?void 0:i.count)??0,profession:(i==null?void 0:i.profession)??"Unknown",professionList:(i==null?void 0:i.professionList)??[]}},Me={maxDownContrib:j([]),maxBarrier:j([]),maxHealing:j([]),maxDodges:j([]),maxStrips:j([]),maxCleanses:j([]),maxCC:j([]),maxStab:j([]),closestToTag:j([])},Ce={},qt=(e,i)=>{if(i==="closestToTag")return Ye(e,i);const s=Math.max(1,(e.totalFightMs||0)/1e3);return Ye(e,i)/s};Object.values(yt).forEach(e=>{const i=e!=="closestToTag";Ce[e]=Mn(on.map(({stat:s})=>({account:s.account,profession:s.profession,professionList:s.professionList,value:qt(s,e),count:s.logsJoined})),i)}),Me.maxDownContrib=j(Ce.downContrib),Me.maxBarrier=j(Ce.barrier),Me.maxHealing=j(Ce.healing),Me.maxDodges=j(Ce.dodges),Me.maxStrips=j(Ce.strips),Me.maxCleanses=j(Ce.cleanses),Me.maxCC=j(Ce.cc),Me.maxStab=j(Ce.stability),Me.closestToTag=j(Ce.closestToTag);const Ut={maxDownContrib:j(J.downContrib),maxBarrier:j(J.barrier),maxHealing:j(J.healing),maxDodges:j(J.dodges),maxStrips:j(J.strips),maxCleanses:j(J.cleanses),maxCC:j(J.cc),maxStab:j(J.stability),closestToTag:j(J.closestToTag)};let sn={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},An,En,Fn=0;if(I!=null&&I.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},i=b=>{const M=e[b];return M?Number(w[M]||0)>0:!1},s=[],k=b=>[...b||[]].filter(M=>i(M==null?void 0:M.name)).sort((M,N)=>N.ratio-M.ratio||M.rank-N.rank||M.name.localeCompare(N.name)).slice(0,3),f=b=>{var N;if(!b)return;const M=k(b.contribs);return{...b,player:b.name,reason:((N=M[0])==null?void 0:N.name)||"Top Performance",topStats:M}};on.forEach(({stat:b})=>{let M=0;const N=[],H=(Y,se,X,Be,fe=!0)=>{var Z,Ue;if(X<=0)return;const Ae=((Z=se[0])==null?void 0:Z.value)||0;if(Ae&&Number.isFinite(Y)&&(fe?Y>0:Y<Number.POSITIVE_INFINITY)){const Ie=fe?Y/Ae:Ae/Y;M+=Ie*X;const He=((Ue=se.find(We=>We.account===b.account))==null?void 0:Ue.rank)||0;N.push({name:Be,ratio:Ie,val:Y.toLocaleString(),rank:He})}};H(b.downContrib,J.downContrib,w.downContribution,"Down Contribution"),H(b.healing,J.healing,w.healing,"Healing"),H(b.cleanses,J.cleanses,w.cleanses,"Cleanses"),H(b.strips,J.strips,w.strips,"Strips"),H(b.stab,J.stability,w.stability,"Stability"),H(b.cc,J.cc,w.cc,"CC"),H(b.revives,J.revives,w.revives,"Revives"),H(Ye(b,"closestToTag"),J.closestToTag,w.distanceToTag,"Distance to Tag",!1),H(b.logsJoined,J.participation,w.participation,"Participation"),H(b.dodges,J.dodges,w.dodging,"Dodging"),H(b.dps,J.dps,w.dps,"DPS"),H(b.damage,J.damage,w.damage,"Damage"),s.push({...b,score:M,contribs:N.filter(Y=>i(Y.name))})}),s.sort((b,M)=>M.score-b.score),s[0]&&s[0].score>0&&(sn=f(s[0])||sn),An=f(s[1]),En=f(s[2]),Fn=s.length>0?s.reduce((b,M)=>b+M.score,0)/s.length:0}const Rt=Object.values(_).sort((e,i)=>{const s=C==="downContribution"?e.downContribution:e.damage;return(C==="downContribution"?i.downContribution:i.damage)-s}).slice(0,25),$t=Object.values(x).sort((e,i)=>i.damage-e.damage).slice(0,25),Lt=e=>{const i=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),s=i.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return s?`${s[1]} Borderlands`:i||"Unknown"},vn=(e,i)=>Lt((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(i==null?void 0:i.fightName)||(i==null?void 0:i.encounterName)||"Unknown"),Ot=(e,i)=>{const s=(i==null?void 0:i.permalink)||(e==null?void 0:e.permalink);if(typeof s=="string"&&s.trim().length>0)return s.trim();const k=e==null?void 0:e.uploadLinks;if(!Array.isArray(k))return"";for(const f of k){if(typeof f=="string"&&f.trim().length>0)return f.trim();if(f&&typeof f=="object"){const b=f.permalink||f.link||f.url||f.reportLink;if(typeof b=="string"&&b.trim().length>0)return b.trim()}}return""},an={};T.forEach(e=>{const i=vn(e==null?void 0:e.details,e);an[i]=(an[i]||0)+1});const xt=Object.entries(an).map(([e,i])=>{const s=String(e).trim(),k=/eternal battlegrounds|^ebg$/i.test(s);let f="#64748b";return k?f="#ffffff":/red/i.test(s)?f="#ef4444":/blue/i.test(s)?f="#3b82f6":/green/i.test(s)&&(f="#22c55e"),{name:e,value:i,color:f}}).sort((e,i)=>i.value-e.value),{boonTables:Ht}=Kn(T),Wt=T.map((e,i)=>{var k,f;const s=((k=e.details)==null?void 0:k.players)||[];return{index:i+1,label:`Log ${i+1}`,timestamp:Oe(e.details,e),squadCount:s.filter(b=>!b.notInSquad).length,friendlyCount:s.length,enemies:((f=e.details)==null?void 0:f.targets).filter(b=>!b.isFake).length}}).sort((e,i)=>e.timestamp-i.timestamp),rn={};Array.from(W.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(rn[e.profession]=(rn[e.profession]||0)+1)});const _t=Object.entries(rn).map(([e,i])=>({name:e,value:i,color:hn(e)})).sort((e,i)=>i.value-e.value),cn={};Object.keys(K).length===0&&T.forEach(e=>{var i,s;(s=(i=e.details)==null?void 0:i.targets)==null||s.forEach(k=>{if(k.isFake)return;const f=k.profession&&k.profession!=="Unknown"?k.profession:k.name||k.id||"Unknown",b=tn(f);cn[b]=(cn[b]||0)+1})});const jt=Object.keys(K).length>0?K:cn,Vt=Object.entries(jt).map(([e,i])=>({name:e,value:i,color:hn(e)})).sort((e,i)=>i.value-e.value),zt=T.map((e,i)=>({log:e,originalIndex:i})).sort((e,i)=>Oe(e.log.details,e.log)-Oe(i.log.details,i.log)).map(({log:e},i)=>{const s=e.details;if(!s)return null;const k=s.players||[],f=k.filter(c=>!c.notInSquad),b=k.filter(c=>c.notInSquad),M=s.targets||[],N=M.filter(c=>!c.isFake),H=f.reduce((c,L)=>{var t,d;return c+(((d=(t=L.dpsAll)==null?void 0:t[0])==null?void 0:d.damage)||0)},0),Y=f.reduce((c,L)=>{var t,d;return c+(((d=(t=L.defenses)==null?void 0:t[0])==null?void 0:d.damageTaken)||0)},0),{enemyDeaths:se,enemyDownsDeaths:X}=ee(s),Be=V(s),fe=Oe(s,e),Ae=vn(s,e),Z={red:0,green:0,blue:0},Ue=c=>{const L=Number(c);return Number.isFinite(L)?L:0},Ie=c=>{if(!c||typeof c!="object")return;const L=c.teamID??c.teamId??c.team??c.teamColor??c.team_color;if(L!=null)return L;const t=Object.keys(c).find(d=>/^team/i.test(d));return t?c[t]:void 0},He=(c,L)=>{if(c==null)return null;if(typeof c=="string"){const t=c.toLowerCase();return t.includes("red")?"red":t.includes("green")?"green":t.includes("blue")?"blue":t==="r"?"red":t==="g"?"green":t==="b"?"blue":null}if(typeof c=="number")if(L==="zeroBased"){if(c===0)return"red";if(c===1)return"green";if(c===2)return"blue"}else{if(c===1)return"red";if(c===2)return"green";if(c===3)return"blue"}return null},We=(c,L)=>{const t={};return c.forEach(d=>{const h=L(d),A=tn(h);A&&(t[A]=(t[A]||0)+1)}),t},Qe=We(f,c=>(c==null?void 0:c.profession)||(c==null?void 0:c.name)),Xe=We(b,c=>(c==null?void 0:c.profession)||(c==null?void 0:c.name)),ln=We(N,c=>(c==null?void 0:c.profession)||(c==null?void 0:c.name)||(c==null?void 0:c.id));if(s.teamCounts&&typeof s.teamCounts=="object"){const c=s.teamCounts;Z.red=Ue(c.red??c.r??c[0]??c[1]),Z.green=Ue(c.green??c.g??c[1]??c[2]),Z.blue=Ue(c.blue??c.b??c[2]??c[3])}else{const c=[];M.forEach(h=>{if(h!=null&&h.isFake)return;const A=Ie(h);A!=null&&c.push(A)}),k.forEach(h=>{if(!(h!=null&&h.notInSquad))return;const A=Ie(h);A!=null&&c.push(A)}),c.length===0&&k.forEach(h=>{const A=Ie(h);A!=null&&c.push(A)});const L=new Set;c.forEach(h=>{typeof h=="number"&&L.add(h)});const t=L.has(0)?"zeroBased":L.has(3)?"oneBased":"zeroBased";if(c.forEach(h=>{const A=He(h,t);A&&(Z[A]+=1)}),Z.red+Z.green+Z.blue===0&&c.length>0){const h=new Map;c.forEach(B=>{const g=String(B);h.set(g,(h.get(g)||0)+1)});const A=Array.from(h.values()).sort((B,g)=>g-B);Z.red=A[0]||0,Z.green=A[1]||0,Z.blue=A[2]||0}Z.red+Z.green+Z.blue===0&&(Z.red=Math.max(N.length,k.filter(h=>h==null?void 0:h.notInSquad).length))}return{id:e.filePath||`fight-${i}`,label:e.encounterName||`Fight ${i+1}`,permalink:Ot(s,e),timestamp:fe,mapName:Ae,duration:Mt(s.durationMS),isWin:Be,squadCount:f.length,allyCount:b.length,enemyCount:N.length,teamCounts:Z,alliesDown:f.reduce((c,L)=>{var t,d;return c+(((d=(t=L.defenses)==null?void 0:t[0])==null?void 0:d.downCount)||0)},0),alliesDead:f.reduce((c,L)=>{var t,d;return c+(((d=(t=L.defenses)==null?void 0:t[0])==null?void 0:d.deadCount)||0)},0),alliesRevived:f.reduce((c,L)=>{var t,d;return Number(((d=(t=L.statsAll)==null?void 0:t[0])==null?void 0:d.saved)||0)>0?c+1:c},0),rallies:0,enemyDeaths:se,enemyDowns:Math.max(0,X-se),totalOutgoingDamage:H,totalIncomingDamage:Y,incomingBarrierAbsorbed:f.reduce((c,L)=>{var t,d;return c+(((d=(t=L.defenses)==null?void 0:t[0])==null?void 0:d.damageBarrier)||0)},0),outgoingBarrierAbsorbed:f.reduce((c,L)=>{var h;const t=(h=L.extBarrierStats)==null?void 0:h.outgoingBarrier;if(!Array.isArray(t))return c;let d=0;return t.forEach(A=>{if(Array.isArray(A)){A.forEach(B=>{d+=Number((B==null?void 0:B.barrier)||0)});return}d+=Number((A==null?void 0:A.barrier)||0)}),c+d},0),squadClassCountsFight:Qe,allyClassCountsFight:Xe,enemyClassCounts:ln}}).filter(Boolean),Kt=Array.from(we.entries()).map(([e,i])=>{const s=Ne.get(e)||{},k=Array.from(i.values()).map(f=>{var se;const b=Array.from(f.professions||[]).filter(X=>X&&X!=="Unknown");let M=f.profession||"Unknown";if(b.length>0){M=b[0];let X=((se=f.professionTimeMs)==null?void 0:se[M])||0;b.forEach(Be=>{var Ae;const fe=((Ae=f.professionTimeMs)==null?void 0:Ae[Be])||0;fe>X&&(X=fe,M=Be)})}const N=f.durationMs||0,H=f.totalMs/1e3,Y=N>0?f.totalMs/N:0;return{account:f.account,profession:M,professionList:b,total:H,perSecond:Y,duration:N/1e3}}).filter(f=>f.total>0||f.perSecond>0);return{id:e,name:s.name||e,icon:s.icon,rows:k}}).filter(e=>e.rows.length>0),Gt=Array.from(re.values()).map(e=>{const i=Array.from(e.skills.values()).sort((k,f)=>f.damage-k.damage),s=i.reduce((k,f)=>(k[f.id]=f,k),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:i,skillMap:s}}).sort((e,i)=>e.displayName.localeCompare(i.displayName));return{total:S,wins:y,losses:p,avgSquadSize:Nt,avgEnemies:Bt,squadKDR:It,enemyKDR:Pt,totalSquadKills:R,totalSquadDeaths:v,totalEnemyKills:$,totalEnemyDeaths:oe,leaderboards:J,...Ut,outgoingConditionSummary:Object.values(Q).sort((e,i)=>i.damage-e.damage),incomingConditionSummary:Object.values(ie).sort((e,i)=>i.damage-e.damage),outgoingConditionPlayers:Array.from(W.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(W.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:Rt,topIncomingSkills:$t,playerSkillBreakdowns:Gt,topSkillsMetric:C,mapData:xt,timelineData:Wt,boonTables:Ht,offensePlayers:Array.from(W.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(W.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),supportPlayers:Array.from(W.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(W.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:sn,silver:An,bronze:En,squadClassData:_t,enemyClassData:Vt,fightBreakdown:zt,specialTables:Kt,topStatsPerSecond:Me,topStatsLeaderboardsPerSecond:Ce,avgMvpScore:Fn}})(),ue=(()=>{const O=new Map,U=new Map,C=[],S=new Map,y=new Map;T.forEach(F=>{const q=F.details;if(!q)return;const v=q.skillMap||{},R=q.fightName||"Log",oe=Oe(q,F)||Date.now(),$={id:F.filePath||F.id||R,label:R,timestamp:oe,skillEntries:{},playerActiveSeconds:{},durationSeconds:q.durationMS?q.durationMS/1e3:0};(q.players||[]).forEach(V=>{if(V.notInSquad)return;const W=V.account||V.name||"Unknown",me=V.profession||"Unknown",_=`${W}|${me}`;let x=U.get(_);x||(x={key:_,account:W,displayName:W,profession:me,professionList:[me],logs:0,totalActiveSeconds:0,skillTotals:{}},U.set(_,x)),x.logs++;const re=(Array.isArray(V.activeTimes)?V.activeTimes[0]:0)/1e3;x.totalActiveSeconds=(x.totalActiveSeconds||0)+re,$.playerActiveSeconds[_]=re,(V.rotation||[]).forEach(Q=>{var Ke,Ge,Je;if(!(Q!=null&&Q.id))return;const ie=((Ke=Q.skills)==null?void 0:Ke.length)||0;if(ie<=0)return;const K=`s${Q.id}`,Ne=((Ge=v[K])==null?void 0:Ge.name)||`Skill ${Q.id}`,we=(Je=v[K])==null?void 0:Je.icon;x.skillTotals[K]=(x.skillTotals[K]||0)+ie,O.set(K,(O.get(K)||0)+ie),S.set(K,Ne),we&&!y.has(K)&&y.set(K,we),$.skillEntries[K]||($.skillEntries[K]={name:Ne,icon:we,players:{}}),!$.skillEntries[K].icon&&we&&($.skillEntries[K].icon=we),$.skillEntries[K].players[_]=($.skillEntries[K].players[_]||0)+ie})}),C.push($)});const p=Array.from(O.entries()).map(([F,q])=>({id:F,name:S.get(F)||F,total:q,icon:y.get(F)})).sort((F,q)=>q.total-F.total);return{logRecords:C,players:Array.from(U.values()),skillOptions:p,resUtilitySkills:[]}})();return{validLogs:T,stats:te,skillUsageData:ue}};let be=null,xe=!1,Dn=null,Tn=0,Sn=0,en=null;const kn=n=>{if(!n||typeof n!="object")return n;const o=(u,D)=>{const T={};return D.forEach(I=>{u&&Object.prototype.hasOwnProperty.call(u,I)&&(T[I]=u[I])}),T},a=o(n,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration"]);return Array.isArray(a.players)&&(a.players=a.players.map(u=>o(u,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","totalDamageTaken","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(a.targets)&&(a.targets=a.targets.map(u=>o(u,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer"]))),a},Ft=n=>{if(!n||typeof n!="object")return n;const o={...n};return n.details?o.details=kn(n.details):o.details=kn(n),o},wn=()=>{if(!xe||!be)return;xe=!1,Tn+=1;const n=en;en=null;const o=Et(be);self.postMessage({type:"result",result:o,computeId:Tn,logCount:be.logs.length,token:Sn,completedAt:Date.now(),flushId:n})},nn=()=>{Dn===null&&(Dn=setInterval(()=>{wn()},5e3))};self.onmessage=n=>{var a,u,D,T;const o=n.data;if((o==null?void 0:o.type)==="reset"){be={logs:[]},typeof o.token=="number"&&(Sn=o.token),xe=!0,nn();return}if((o==null?void 0:o.type)==="settings"){be={logs:(be==null?void 0:be.logs)||[],precomputedStats:(a=o.payload)==null?void 0:a.precomputedStats,mvpWeights:(u=o.payload)==null?void 0:u.mvpWeights,statsViewSettings:(D=o.payload)==null?void 0:D.statsViewSettings,disruptionMethod:(T=o.payload)==null?void 0:T.disruptionMethod},xe=!0,nn();return}if((o==null?void 0:o.type)==="log"){be||(be={logs:[]}),be.logs.push(Ft(o.payload)),xe=!0,nn();return}(o==null?void 0:o.type)==="flush"&&(typeof o.flushId=="number"&&(en=o.flushId),xe=!0,wn())}})();
